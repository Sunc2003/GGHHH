{% load static %}
{% load permisos_tags %}
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{% block title %}GGH{% endblock %}</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="{% static 'css/base.css' %}" rel="stylesheet" />

  <style>
    .badge-counter{
      background:#dc3545;color:#fff;font-size:.75rem;padding:.25em .6em;border-radius:10rem;
    }
  </style>

  {% block extra_css %}{% endblock %}
</head>
<body class="d-flex flex-column min-vh-100">

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
      <a class="navbar-brand" href="/">
        <img src="{% static 'img/ggh.png' %}" alt="GGH" width="120" height="100" style="filter: drop-shadow(2px 2px 10px #232323);">
      </a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
        <span class="navbar-toggler-icon"></span>
      </button>

      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto">
          <li class="nav-item"><a class="nav-link" href="{% url 'panel_admin_usuarios' %}">Home</a></li>

          {% if request.user.is_authenticated and request.user|tiene_permiso:"SOLICITUD_CODIGO" %}
            <li class="nav-item"><a class="nav-link" href="{% url 'nueva_solicitud' %}">Solicitud de código</a></li>
          {% endif %}

          <li class="nav-item"><a class="nav-link" href="{% url 'usuarios_ad' %}">Usuarios AD</a></li>
          <li class="nav-item"><a class="nav-link" href="{% url 'crear_permiso' %}">Gestión de Permisos</a></li>

          {% if request.user.is_authenticated and request.user|tiene_permiso:"PROCESOS" %}
            <li class="nav-item"><a class="nav-link" href="{% url 'procesos' %}">Procesos</a></li>
          {% endif %}

          {% if request.user.is_authenticated and request.user|tiene_permiso:"BUSCAR_PRODUCTOS_SAP" %}
            <li class="nav-item"><a class="nav-link" href="{% url 'buscar_productos_ui' %}">Buscar Productos</a></li>
          {% endif %}

          {% if request.user.is_authenticated and request.user|tiene_permiso:"BUSCAR_SOCIOS" %}
            <li class="nav-item"><a class="nav-link" href="{% url 'socios_lista' %}">Socios</a></li>
          {% endif %}
        </ul>

        <ul class="navbar-nav ms-auto">
          {% if user.is_authenticated %}
            {% if request.user|tiene_permiso:"VER_SOLICITUDES_RECIBIDAS" %}
              <li class="nav-item position-relative">
                <a class="nav-link position-relative" href="{% url 'solicitudes_recibidas' %}" title="Solicitudes pendientes">
                  <i class="fa fa-bell"></i>
                  <span id="badge-solicitudes" class="badge-counter position-absolute top-0 start-100 translate-middle" style="display:none;">0</span>
                </a>
              </li>
            {% endif %}

            {% if user.tipo_usuario == 'admin' %}
              <li class="nav-item"><a class="nav-link" href="{% url 'panel_admin_usuarios' %}">Panel Admin</a></li>
            {% endif %}

            <li class="nav-item"><a class="nav-link" href="{% url 'perfil_usuario' %}">{{ user.get_full_name|default:user.username }}</a></li>
            <li class="nav-item">
              <form method="post" action="{% url 'logout' %}" style="display:inline;">
                {% csrf_token %}
                <button type="submit" class="btn btn-link nav-link" title="Cerrar sesión" style="display:inline; padding:0;" aria-label="Cerrar sesión">
                  <i class="fas fa-power-off"></i>
                </button>
              </form>
            </li>
          {% else %}
            <li class="nav-item"><a class="nav-link" href="{% url 'login' %}">Iniciar sesión</a></li>
          {% endif %}
        </ul>
      </div>
    </div>
  </nav>

  <!-- Contenido principal -->
  <main class="flex-grow-1">
    <div class="container mt-5">
      {% block content %}{% endblock %}
    </div>
  </main>

  <!-- Footer -->

  <footer class="site-footer bg-dark text-white mt-auto">
    <div class="container d-flex flex-column flex-md-row align-items-center justify-content-between py-4">
      <div class="footer-logo mb-3 mb-md-0">
        <img src="{% static 'img/logomarsella.png' %}" alt="Logo Marsella" height="60" style="filter: drop-shadow(2px 2px 10px #434040);">
      </div>
      <div class="footer-contact text-white ms-md-4">
        <p class="fw-bold mb-2" style="font-size:1.3rem; letter-spacing:0.5px;">CONTACTO</p>
        <div style="line-height:1.7; font-size:1.05rem;">
          Casa central: Av. España #2501,<br>
          Batuco, Lampa. Santiago, Chile.<br><br>
          Antofagasta: El Quisco #678<br>
          Correo: <a href="mailto:contacto@ggh.cl" class="footer-link">contacto@ggh.cl</a><br>
          Whatsapp: <a href="https://wa.me/56952167864" class="footer-link">+569 5216 7864</a><br>
          Chile
        </div>
      </div>
    </div>
  </footer>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <!-- Toast (único aviso visual) -->
{% if request.user.is_authenticated and request.user|tiene_permiso:"VER_SOLICITUDES_RECIBIDAS" %}
  <div class="position-fixed top-0 end-0 p-3" style="z-index:1080">
    <div id="toast-nueva-solicitud" class="toast" role="alert" aria-live="assertive" aria-atomic="true"
         data-bs-autohide="true" data-bs-delay="3000">
      <div class="toast-header">
        <i class="fa fa-bell me-2"></i>
        <strong class="me-auto">Nueva solicitud</strong>
        <small class="text-muted">justo ahora</small>
        <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Cerrar"></button>
      </div>
      <div class="toast-body">
        ¡Tienes una nueva solicitud de: <strong id="toast-remitente">—</strong>
        (<span id="toast-titulo">—</span>)!
        <a id="toast-link" href="{% url 'solicitudes_recibidas' %}" class="link-dark fw-semibold ms-1">Ver</a>
      </div>
    </div>
  </div>
  {% endif %}
  <!-- Sonido (opcional) -->
  <audio id="snd-nueva-solicitud" preload="auto">
    <source src="{% static 'sonidos/notify.mp3' %}" type="audio/mpeg">
  </audio>

  <!-- Script: contador + toast (sin otros mensajes) -->
  <script>
  (function(){
    const badge      = document.getElementById('badge-solicitudes');
    if(!badge) return;

    const toastEl    = document.getElementById('toast-nueva-solicitud');
    const toast      = bootstrap.Toast.getOrCreateInstance(toastEl, { autohide: true, delay: 3000 });
    const toastRem   = document.getElementById('toast-remitente');
    const toastTit   = document.getElementById('toast-titulo');
    const toastLink  = document.getElementById('toast-link');
    const snd        = document.getElementById('snd-nueva-solicitud');

    // desbloqueo de audio (opcional)
    let audioUnlocked = false;
    function unlockAudioOnce(){
      if (!snd || audioUnlocked) return;
      snd.play().then(()=>{ snd.pause(); snd.currentTime = 0; audioUnlocked = true; })
                .catch(()=>{});
    }
    document.addEventListener('click', unlockAudioOnce, { once:false });
    document.addEventListener('keydown', unlockAudioOnce, { once:false });

    // Estado visto
    let lastSeenId = parseInt(localStorage.getItem('ultima_solicitud_id') || '0', 10);
    let initialized = !!lastSeenId;  // primera corrida sin mostrar

    async function refresh(){
      try{
        const res = await fetch("{% url 'api_solicitudes_pendientes_count' %}", {
          headers:{ 'X-Requested-With':'XMLHttpRequest' }
        });
        const data = await res.json();

        const n   = data.count || 0;
        const uid = data.ultimo_id || 0;

        // badge
        if (n > 0){ badge.textContent = n > 99 ? '99+' : n; badge.style.display = 'inline-block'; }
        else { badge.style.display = 'none'; }

        if (!uid) return;

        // primera lectura: solo inicializa
        if (!initialized){
          lastSeenId = uid;
          localStorage.setItem('ultima_solicitud_id', String(uid));
          initialized = true;
          return;
        }

        // si hay nueva solicitud real
        if (uid !== lastSeenId){
          // marcar como visto ANTES de mostrar para que no repita
          lastSeenId = uid;
          localStorage.setItem('ultima_solicitud_id', String(uid));

          // rellenar y mostrar
          toastRem.textContent = data.remitente || '—';
          toastTit.textContent = data.titulo || '—';
          if (toastLink){
            toastLink.href = "{% url 'detalle_solicitud' 0 %}".replace('/0/', `/${uid}/`);
          }
          toast.show();

          // sonido (opcional)
          if (snd){
            try{ snd.currentTime = 0; await snd.play(); }catch(e){}
          }
        }

      }catch(e){
        console.warn('Error consultando notificaciones:', e);
      }
    }

    // polling
    let timer = null;
    function start(){ if(!timer){ timer = setInterval(refresh, 10000); } }
    function stop(){ if(timer){ clearInterval(timer); timer = null; } }

    document.addEventListener('visibilitychange', () => {
      if (document.hidden) stop(); else { refresh(); start(); }
    });

    refresh();
    start();
  })();
  </script>

  {% block extra_js %}{% endblock %}
</body>
</html>
