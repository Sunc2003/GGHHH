{% extends "base.html" %}
{% load static %}

{% block content %}
<style>
:root{ --ink:#111; --muted:#555; --line:#dcdcdc; --fill:#fff; --fill-soft:#f5f5f5; }
body{ color:var(--ink); background:#fff; }

.page-header{ display:flex; align-items:center; justify-content:space-between; padding-bottom:.75rem; margin-bottom:1.25rem; border-bottom:2px solid var(--line);}
.page-title{ margin:0; font-weight:800; font-size:1.6rem; }
.ghost-btn{ display:inline-flex; align-items:center; gap:.5rem; padding:.4rem .75rem; border:1px solid var(--line); background:var(--fill); color:var(--ink); text-decoration:none; border-radius:6px;}
.ghost-btn:hover{ background:var(--fill-soft); }

.card{ background:var(--fill); border:1px solid var(--line); border-radius:8px; padding:1rem; margin-bottom:1.5rem; box-shadow:0 2px 4px rgba(0,0,0,0.05);}
.section-title{ margin:0 0 .75rem 0; font-weight:700; font-size:1rem; color:var(--muted); text-transform:uppercase; }

.data-table{ width:100%; border-collapse:collapse; font-size:.9rem; }
.data-table thead th{ background:var(--fill-soft); font-weight:700; border:1px solid var(--line); padding:.55rem .65rem; text-align:center;}
.data-table tbody td{ border:1px solid var(--line); padding:.55rem .65rem; text-align:center;}
.data-table tbody tr:nth-child(odd){ background:#fafafa;}
.num{ text-align:right; font-variant-numeric:tabular-nums; }

.nav-tabs .nav-link{ border:1px solid var(--line); border-bottom:none; border-radius:0; color:var(--muted); font-weight:600; background:var(--fill-soft);}
.nav-tabs .nav-link.active{ background:var(--fill); color:var(--ink); border-top:2px solid #000; border-bottom:1px solid var(--fill); font-weight:700;}
.nav-tabs{ margin-bottom:1rem; border-bottom:1px solid var(--line);}
</style>

<div class="container py-4">
  <div class="page-header">
    <h4 class="page-title">Detalle del Cliente</h4>
    <a href="{{ request.META.HTTP_REFERER }}" class="ghost-btn">
      <i class="fas fa-arrow-left"></i> Volver
    </a>
  </div>

  {% if error %}<div class="alert alert-danger">{{ error }}</div>{% endif %}

  {% if detalle %}
    <!-- Información general -->
    <div class="card mb-4">
      <h5 class="section-title">Información General</h5>
      <table class="table table-bordered">
        <tr><th>Código</th><td>{{ detalle.socio.CardCode }}</td></tr>
        <tr><th>Nombre</th><td>{{ detalle.socio.CardName }}</td></tr>
        <tr><th>Límite de Crédito</th><td class="num">$ {{ detalle.socio.CreditLine }}</td></tr>
        <tr><th>Saldo</th><td class="num">$ {{ detalle.socio.Balance }}</td></tr>
        <tr><th>Crédito Disponible</th><td class="num">$ {{ detalle.socio.CreditoDisponible }}</td></tr>
      </table>
    </div>

    <!-- Tabs -->
    <ul class="nav nav-tabs" id="detalleTabs">
      <li class="nav-item"><a class="nav-link active" data-bs-toggle="tab" href="#direcciones">Direcciones</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#ov">OV Abiertas</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#guias">Guías Pendientes</a></li>
      <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" href="#facturas">Facturas Vencidas</a></li>
    </ul>

    <div class="tab-content">
      <!-- Direcciones -->
      <div class="tab-pane fade show active" id="direcciones">
        <div class="card">
          <h5 class="section-title">Direcciones</h5>
          {% if detalle.direcciones %}
            <table class="data-table">
              <thead><tr><th>Nombre</th><th>Tipo</th><th>Calle</th><th>Ciudad</th><th>Comuna</th><th>Región</th><th>País</th><th>Zip</th></tr></thead>
              <tbody>
                {% for d in detalle.direcciones %}
                <tr>
                  <td>{{ d.NombreDireccion }}</td>
                  <td>{% if d.Tipo == 'B' %}Facturación{% elif d.Tipo == 'S' %}Despacho{% else %}{{ d.Tipo }}{% endif %}</td>
                  <td>{{ d.Calle }}</td><td>{{ d.Ciudad }}</td><td>{{ d.Comuna }}</td>
                  <td>{{ d.Region }}</td><td>{{ d.Pais }}</td><td>{{ d.ZipCode }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}<p class="text-muted">Sin direcciones registradas.</p>{% endif %}
        </div>
      </div>

      <!-- OV Abiertas -->
      <div class="tab-pane fade" id="ov">
        <div class="card">
          <h5 class="section-title">Órdenes de Venta Abiertas</h5>
          {% if ov_abiertas %}
            <table class="data-table">
              <thead><tr><th>N° Doc</th><th>Fecha</th><th>Vencimiento</th><th>Total Neto</th><th>Moneda</th><th>Vendedor</th><th></th></tr></thead>
              <tbody>
                {% for ov in ov_abiertas %}
                <tr>
                  <td>{{ ov.DocNum }}</td><td>{{ ov.DocDate }}</td><td>{{ ov.DocDueDate }}</td>
                  <td class="num">$ {{ ov.TotalNeto }}</td><td>{{ ov.DocCur }}</td><td>{{ ov.Vendedor }}</td>
                  <td>
                    <a href="{% url 'ov_detalle' cardcode=cardcode docnum=ov.DocNum %}" class="btn btn-sm btn-outline-primary">Ver detalle</a>
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}<p class="text-muted">No hay órdenes de venta abiertas.</p>{% endif %}
        </div>
      </div>

      <!-- Guías Pendientes -->
      <div class="tab-pane fade" id="guias">
        <div class="card">
          <h5 class="section-title">Guías Pendientes de Facturar</h5>
          {% if guias_pendientes %}
            {% regroup guias_pendientes by DocNum as grouped_guias %}
            {% for guia in grouped_guias %}
              <div class="mb-3">
                <h6 class="fw-bold">Guía {{ guia.grouper }} — {{ guia.list.0.DocDate }}</h6>
                <table class="data-table">
                  <thead><tr><th>Item</th><th>Descripción</th><th>Cantidad</th><th>Pendiente</th></tr></thead>
                  <tbody>
                    {% for item in guia.list %}
                    <tr>
                      <td>{{ item.ItemCode }}</td><td>{{ item.Dscription }}</td>
                      <td class="num">{{ item.Quantity }}</td><td class="num">{{ item.OpenQty }}</td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
            {% endfor %}
          {% else %}<p class="text-muted">No hay guías pendientes de facturar.</p>{% endif %}
        </div>
      </div>

      <!-- Facturas Vencidas -->
      <div class="tab-pane fade" id="facturas">
        <div class="card">
          <h5 class="section-title">Facturas Vencidas</h5>
          {% if facturas_vencidas %}
            <table class="data-table">
              <thead><tr><th>N° Factura</th><th>Fecha</th><th>Vencimiento</th><th>Saldo</th><th>Moneda</th></tr></thead>
              <tbody>
                {% for fac in facturas_vencidas %}
                <tr>
                  <td>{{ fac.DocNum }}</td><td>{{ fac.DocDate }}</td><td>{{ fac.DocDueDate }}</td>
                  <td class="num">$ {{ fac.Saldo }}</td><td>{{ fac.DocCur }}</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          {% else %}<p class="text-muted">No hay facturas vencidas.</p>{% endif %}
        </div>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}
