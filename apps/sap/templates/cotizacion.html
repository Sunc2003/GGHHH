{% extends "base.html" %}
{% load static %}

{% block content %}
<div class="cotizacion-wrapper py-4 px-2 px-md-4">
  <div class="cotizacion-card shadow-sm p-4 bg-white rounded-2 border-0">
    <!-- HEADER -->
    <div class="d-flex justify-content-between align-items-center flex-wrap mb-4">
      <div class="d-flex align-items-center gap-3">
        <img src="{% static 'img/ggh.png' %}" alt="Ferreter√≠a Marsella" class="logo-header">
        <h3 class="fw-semibold titulo-seccion mb-0">Nueva Cotizaci√≥n</h3>
      </div>
    </div>

    <!-- DATOS GENERALES -->
    <div class="section-title mb-3">Datos Generales</div>
    <div class="row g-3">
      <div class="col-12 col-md-4">
        <label class="form-label">CardCode (Cliente)</label>
        <input id="cardCode" class="form-control" placeholder="Ej: C77260520-K" />
      </div>
      <div class="col-12 col-md-4">
        <label class="form-label">SalesPersonCode</label>
        <input id="slp" type="number" class="form-control" placeholder="Ej: 74" />
      </div>
      <div class="col-12 col-md-4">
        <label class="form-label">DocDate</label>
        <input id="docDate" type="date" class="form-control" readonly />
      </div>
      <div class="col-12 col-md-4">
        <label class="form-label">DocDueDate</label>
        <input id="dueDate" type="date" class="form-control" readonly />
      </div>
      <div class="col-12 col-md-4">
        <label class="form-label">ShipToCode</label>
        <input id="shipTo" class="form-control" placeholder="Ej: DESPACHO LAMPA" />
      </div>
      <div class="col-12 col-md-4">
        <label class="form-label">PayToCode</label>
        <input id="payTo" class="form-control" placeholder="Ej: OFICINA CENTRAL" />
      </div>
    </div>

    <!-- L√çNEAS DE PRODUCTOS -->
    <div class="section-title mt-5 mb-3">L√≠neas de Productos</div>
    <div class="table-responsive border border-light rounded-2">
      <table id="linesTbl" class="table table-sm align-middle text-center mb-0">
        <thead class="table-header">
          <tr>
            <th>ItemCode</th>
            <th>Descripci√≥n</th>
            <th>Cant.</th>
            <th>Precio</th>
            <th>Bodega</th>
            <th>Entrega</th>
            <th>Impuesto</th>
            <th></th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>

    <button id="addLineBtn" type="button" class="btn btn-outline-fiori btn-sm mt-2">
      <i class="fa-solid fa-plus me-1"></i>Agregar l√≠nea
    </button>

    <!-- BOTONES -->
    <div class="acciones d-flex flex-wrap justify-content-end gap-2 mt-4">
      <button id="clearBtn" class="btn btn-outline-fiori">
        <i class="fa-solid fa-eraser me-1"></i>Limpiar
      </button>
      <button id="previewBtn" type="button" class="btn btn-outline-fiori">
        <i class="fa-solid fa-eye me-1"></i>Vista previa
      </button>
      <button id="submitBtn" data-endpoint="{% url 'cotizacion_crear' %}" class="btn btn-fiori">
        <i class="fa-solid fa-paper-plane me-1"></i>Crear Cotizaci√≥n
      </button>
      
      <button id="pdfBtn" class="btn btn-outline-fiori d-none">
        <i class="fa-solid fa-file-pdf me-1"></i> Generar PDF
      </button>
    </div>

    <div id="msgOk" class="alert alert-success mt-3 d-none"></div>
    <div id="msgErr" class="alert alert-danger mt-3 d-none"></div>
  </div>
</div>

<!-- ================== MODAL BUSCADOR ================== -->
<div class="modal fade" id="buscadorModal" tabindex="-1">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content border-0 shadow-sm rounded-2">
      <div class="modal-header modal-fiori-header">
        <h5 class="modal-title fw-semibold">
          <i class="fa-solid fa-magnifying-glass me-2"></i>Buscar Producto (Inventario SAP)
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body bg-white">
        <input id="buscadorInput" type="text" class="form-control mb-3"
          placeholder="üîç Buscar por descripci√≥n o c√≥digo...">
        <div class="table-responsive border rounded-2">
          <table class="table table-hover align-middle text-center mb-0" id="tablaResultados">
            <thead class="table-header">
              <tr>
                <th>C√≥digo</th>
                <th>Descripci√≥n</th>
                <th>Fabricante</th>
                <th>Proveedor</th>
                <th>Cod Prov.</th>
                <th>A01</th>
                <th>A02</th>
                <th>A08</th>
                <th>PMV</th>
                <th>√ölt. Precio</th>
                <th>√ölt. Fecha</th>
                <th>Origen</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>

      <div class="modal-footer modal-fiori-footer">
        <small class="text-muted">
          <i class="fa-regular fa-circle-info me-1"></i>Selecciona una fila para agregar el producto.
        </small>
      </div>
    </div>
  </div>
</div>

<!-- ================== MODAL VISTA PREVIA ================== -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content border-0 shadow-sm rounded-2">
      <div class="modal-header modal-fiori-header">
        <h5 class="modal-title fw-semibold" id="previewModalLabel">
          <i class="fa-solid fa-eye me-2"></i>Vista Previa de Cotizaci√≥n
        </h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>

      <div class="modal-body bg-white">
        <!-- Tabla para escritorio -->
        <div class="table-responsive border rounded-2 d-none d-md-block">
          <table class="table table-hover align-middle text-center mb-0" id="previewTable">
            <thead class="table-header">
              <tr>
                <th>ItemCode</th>
                <th>Descripci√≥n</th>
                <th>Cantidad</th>
                <th>Precio Unitario</th>
                <th>Bodega</th>
                <th>Entrega</th>
                <th>Impuesto</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>

        <!-- Versi√≥n m√≥vil -->
        <div class="mobile-preview d-md-none" id="mobilePreviewContainer"></div>

        <!-- Totales -->
        <div class="mt-3 text-end fw-semibold" id="previewTotal">
          Neto: <b>$0</b> | IVA (19%): <b>$0</b> | Total: <b>$0</b>
        </div>
      </div>

      

      <div class="modal-footer modal-fiori-footer">
        <button type="button" class="btn btn-outline-fiori" data-bs-dismiss="modal">
          <i class="fa-solid fa-xmark me-1"></i>Cerrar
        </button>
        <button type="button" id="savePreviewBtn" class="btn btn-fiori">
          <i class="fa-solid fa-save me-1"></i>Guardar Cambios
        </button>
      </div>
    </div>
  </div>
</div>



<!-- ================== ESTILOS ================== -->


<style>
:root {
  --color-bg: #f8fafc;
  --color-card: #ffffff;
  --color-border: #c8c8c8;
  --color-border-light: #e0e0e0;
  --color-text: #000;
  --color-primary: #0078d7;
  --color-primary-dark: #005a9e;
  --color-danger: #dc3545;
  --radius: 8px;
  --shadow-sm: 0 1px 4px rgba(0, 0, 0, 0.08);
  --transition: 0.25s ease-in-out;
}

/* ===== GENERAL ===== */
body {
  background-color: var(--color-bg);
  color: var(--color-text);
  font-family: "Inter", "Segoe UI", Roboto, sans-serif;
  font-size: 0.93rem;
}

/* ===== HEADER ===== */
.logo-header {
  width: 110px;
  object-fit: contain;
}
.titulo-seccion {
  font-size: 1.45rem;
  font-weight: 600;
  color: var(--color-text);
}

/* ===== FORMULARIOS ===== */
.form-label {
  font-size: 0.83rem;
  color: var(--color-text);
  font-weight: 500;
}
.form-control {
  border: 1px solid var(--color-border);
  border-radius: var(--radius);
  font-size: 0.9rem;
  padding: 0.45rem 0.6rem;
  color: var(--color-text);
}
.form-control:focus {
  border-color: var(--color-primary);
  box-shadow: none;
  outline: none;
}

/* ===== TABLAS ===== */
.table {
  font-size: 0.86rem;
  border-collapse: collapse;
  color: var(--color-text);
}
.table-header {
  background: #efefef;
  font-weight: 600;
  text-transform: uppercase;
  border-bottom: 1px solid var(--color-border);
}
.table td,
.table th {
  padding: 0.55rem;
  border: 1px solid var(--color-border);
  vertical-align: middle;
}

/* ===== BOTONES ===== */
.btn {
  font-size: 0.87rem;
  border-radius: var(--radius) !important;
  font-weight: 500;
  transition: var(--transition);
}
.btn-fiori {
  background-color: var(--color-primary);
  color: #fff;
  border: none;
}
.btn-fiori:hover {
  background-color: var(--color-primary-dark);
}
.btn-outline-fiori {
  background: #fff;
  color: var(--color-text);
  border: 1px solid var(--color-border);
}
.btn-outline-fiori:hover {
  background-color: #f1f5f9;
  border-color: var(--color-primary);
  color: var(--color-primary);
}

/* ===== MODAL ===== */
.modal-content {
  border-radius: var(--radius);
  border: 1px solid var(--color-border);
}
.modal-header {
  background-color: #f1f3f4;
  border-bottom: 1px solid var(--color-border);
}
.modal-title {
  font-size: 1rem;
  font-weight: 600;
}

/* ===== BOT√ìN DE B√öSQUEDA (LUPA) ===== */
.position-relative {
  position: relative;
}
.desc-buscar {
  width: 100%;
  border: 1px solid var(--color-border);
  border-radius: var(--radius);
  height: 36px;
  font-size: 0.9rem;
  padding: 0.4rem 2.2rem 0.4rem 0.6rem;
  background-color: #fff;
  color: var(--color-text);
  transition: border-color 0.2s ease-in-out;
}
.desc-buscar:focus {
  border-color: var(--color-primary);
  outline: none;
}
.btn-buscar {
  position: absolute;
  top: 50%;
  right: 8px;
  transform: translateY(-50%);
  width: 28px;
  height: 28px;
  border-radius: 50%;
  border: 1px solid var(--color-border-light);
  background-color: #f5f7f9;
  color: #444;
  font-size: 0.8rem;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 1px 2px rgba(0,0,0,0.05);
  transition: all 0.2s ease-in-out;
  cursor: pointer;
}
.btn-buscar:hover {
  background-color: #e4e8ec;
  color: var(--color-primary-dark);
  border-color: var(--color-primary);
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

/* ===== EFECTO HOVER ===== */
#tablaResultados tr:hover td {
  background-color: #d8f5d0 !important;
  transition: background-color 0.25s ease-in-out;
}
#tablaResultados tr.selected td {
  background-color: #b7e6b1 !important;
  font-weight: 600;
}

/* ===== ALERTAS ===== */
.alert {
  font-size: 0.85rem;
  border-radius: var(--radius);
  border: 1px solid var(--color-border);
}

/* ===== RESPONSIVE ===== */
@media (max-width: 768px) {
  .btn { width: 100%; }
}

/* ===== MODAL VISTA PREVIA ===== */
#previewModal .modal-body {
  max-height: 70vh;
  overflow-y: auto;
}

#previewModal table td input {
  width: 100%;
  border: 1px solid var(--color-border);
  border-radius: 4px;
  font-size: 0.88rem;
  padding: 0.3rem 0.5rem;
}

#previewModal table td input:focus {
  border-color: var(--color-primary);
  outline: none;
}

#previewModal .modal-title {
  font-size: 1.05rem;
}

#previewModal .table th {
  background-color: #f1f3f4;
  font-size: 0.85rem;
  text-transform: uppercase;
}

#previewTotal {
  font-size: 0.9rem;
  color: var(--color-text);
}

</style>


<script>
/* ===================== UTILIDAD CSRF ===================== */
function getCookie(name){
  const m=document.cookie.match('(^|;)\\s*'+name+'\\s*=\\s*([^;]+)');
  return m?m.pop():'';
}

/* ===================== FECHAS AUTOM√ÅTICAS ===================== */
document.addEventListener("DOMContentLoaded",()=>{
  const today=new Date();
  const yyyy=today.getFullYear(),mm=String(today.getMonth()+1).padStart(2,"0"),dd=String(today.getDate()).padStart(2,"0");
  const currentDate=`${yyyy}-${mm}-${dd}`;
  document.querySelectorAll("#docDate,#dueDate").forEach(el=>el.value=currentDate);
});

/* ===================== TABLA PRINCIPAL ===================== */
const tbody=document.querySelector('#linesTbl tbody');
document.querySelector('#addLineBtn').addEventListener('click',()=>addLineRow());
document.querySelector('#clearBtn').addEventListener('click',()=>{tbody.innerHTML='';addLineRow();});

function addLineRow(prefill = {}) {
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input placeholder="ItemCode" value="${prefill.Codigo || ''}" readonly /></td>
    <td class="position-relative">
      <input class="desc-buscar" placeholder="Buscar producto..." value="${prefill.ItemName || ''}" />
      <button type="button" class="btn btn-link btn-buscar" aria-label="Buscar producto"><i class="fa-solid fa-magnifying-glass"></i></button>
    </td>
    <td><input type="number" min="1" step="1" placeholder="Qty" value="${prefill.Quantity ?? ''}" /></td>
    <td><input type="number" min="0" step="0.01" placeholder="UnitPrice" value="${prefill.UnitPrice ?? ''}" /></td>
    <td><input placeholder="Warehouse" value="${prefill.WarehouseCode || 'A01'}" /></td>
    <td><input type="text" placeholder="Ej: 2 d√≠as" value="${prefill.U_GGH_TIM || ''}" /></td>
    <td><input placeholder="TaxCode" value="${prefill.TaxCode || 'IVA'}" /></td>
    <td><button type="button" class="btn btn-sm btn-outline-danger rm" aria-label="Eliminar l√≠nea"><i class="fa-solid fa-trash"></i></button></td>
  `;
  tr.querySelector('.rm').addEventListener('click', () => tr.remove());
  tr.querySelector('.btn-buscar').addEventListener('click', () => abrirModalBusqueda(tr));
  tbody.appendChild(tr);
}
addLineRow();

/* ===================== MODAL DE B√öSQUEDA (simple y estable) ===================== */
function abrirModalBusqueda(tr){
  const modalEl = document.getElementById('buscadorModal');
  if (!modalEl) { console.error('No existe #buscadorModal'); return; }
  const modal = bootstrap.Modal.getOrCreateInstance(modalEl);

  const input = document.getElementById('buscadorInput');
  const tableBody = document.querySelector('#tablaResultados tbody');
  if (!input || !tableBody) { console.error('Falta #buscadorInput o #tablaResultados tbody'); return; }

  // Reset y abrir
  input.value = '';
  tableBody.innerHTML = '';
  modal.show();

  // Un √∫nico handler (se reemplaza cada vez que se abre)
  input.oninput = async () => {
    const q = input.value.trim();
    if (q.length < 2) { tableBody.innerHTML = ''; return; }

    const url = `/buscar_items_inventario/?q=${encodeURIComponent(q)}`;
    try {
      const res = await fetch(url);
      const data = await res.json();

      if (!Array.isArray(data) || data.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="12" class="text-muted text-center">Sin resultados</td></tr>';
        return;
      }

      tableBody.innerHTML = data.map(it => `
        <tr data-code="${it.Codigo}" data-name="${it.ItemName}" data-price="${it.PMV || 0}">
          <td>${it.Codigo}</td>
          <td>${it.ItemName}</td>
          <td>${it.FirmName || ''}</td>
          <td>${it.ProveedorName || ''}</td>
          <td>${it.ProveedorCode || ''}</td>
          <td>${it.Stock_A01 || 0}</td>
          <td>${it.Stock_A02 || 0}</td>
          <td>${it.Stock_A08 || 0}</td>
          <td>${it.PMV || ''}</td>
          <td>${it.UltimoPrecioCompra || ''}</td>
          <td>${it.UltimaFechaCompra ? it.UltimaFechaCompra.split('T')[0] : ''}</td>
          <td>${it.Origen || ''}</td>
        </tr>
      `).join('');

      tableBody.querySelectorAll('tr').forEach(row => {
        row.addEventListener('click', () => {
          tableBody.querySelectorAll('tr').forEach(r => r.classList.remove('selected'));
          row.classList.add('selected');
          tr.querySelector('input.desc-buscar').value = row.dataset.name;
          tr.querySelector('input[placeholder="ItemCode"]').value  = row.dataset.code;
          tr.querySelector('input[placeholder="UnitPrice"]').value = row.dataset.price;
          setTimeout(() => modal.hide(), 120);
        });
      });
    } catch (e) {
      console.error(e);
      tableBody.innerHTML = '<tr><td colspan="12" class="text-danger text-center">‚ö†Ô∏è Error al buscar productos</td></tr>';
    }
  };
}

/* ===================== CREAR COTIZACI√ìN (POST) ===================== */
document.querySelector('#submitBtn').addEventListener('click',async()=>{
  const msgOk=document.querySelector('#msgOk'),msgErr=document.querySelector('#msgErr');
  msgOk.classList.add('d-none');msgErr.classList.add('d-none');
  const endpoint=document.querySelector('#submitBtn').dataset.endpoint;
  const cardCode=document.querySelector('#cardCode').value.trim();
  const docDate=document.querySelector('#docDate').value;
  const dueDate=document.querySelector('#dueDate').value;
  if(!cardCode||!docDate||!dueDate){
    msgErr.textContent="Faltan campos obligatorios";
    msgErr.classList.remove('d-none'); return;
  }

  const lines=[];
  tbody.querySelectorAll('tr').forEach(tr=>{
    const tds=tr.querySelectorAll('input');
    const line={
      ItemCode:tds[0].value.trim(),
      ItemDescription:tds[1].value.trim(),
      Quantity:Number(tds[2].value),
      UnitPrice:Number(tds[3].value),
      WarehouseCode:tds[4].value.trim(),
      U_GGH_TIM:tds[5].value.trim(),
      TaxCode:tds[6].value.trim()
    };
    if(line.ItemCode && line.Quantity>0) lines.push(line);
  });

  if(!lines.length){
    msgErr.textContent="Debes ingresar al menos una l√≠nea v√°lida.";
    msgErr.classList.remove('d-none'); return;
  }

  const payload={DocDate:docDate,DocDueDate:dueDate,CardCode:cardCode,DocumentLines:lines};
  try{
    const resp=await fetch(endpoint,{
      method:"POST",
      headers:{"Content-Type":"application/json","X-CSRFToken":getCookie('csrftoken')},
      credentials:"same-origin",
      body:JSON.stringify(payload)
    });
    const data=await resp.json();
    if(!resp.ok)throw new Error(data.detail||"Error al crear cotizaci√≥n");
    msgOk.innerHTML=`‚úÖ Cotizaci√≥n creada. DocEntry: <b>${data.DocEntry}</b>`;
    msgOk.classList.remove('d-none');
  }catch(err){
    msgErr.textContent=String(err);
    msgErr.classList.remove('d-none');
  }
});

/* ===================== BOT√ìN PDF (BACKEND) ===================== */
document.addEventListener("DOMContentLoaded", () => {
  const pdfBtn = document.getElementById("pdfBtn");
  const okEl = document.getElementById("msgOk");
  if (!pdfBtn || !okEl) return;

  const observer = new MutationObserver(() => {
    if (document.querySelector("#msgOk:not(.d-none)")) {
      pdfBtn.classList.remove("d-none");
    }
  });
  observer.observe(okEl, { attributes: true, attributeFilter: ["class"] });

  pdfBtn.addEventListener("click", () => {
    const msg = okEl.innerHTML;
    const match = msg.match(/DocEntry:\s*<b>(\d+)<\/b>/);
    if (!match) return alert("‚ö†Ô∏è Primero crea la cotizaci√≥n.");
    const docEntry = match[1];
    window.open(`/sap/cotizacion/${docEntry}/pdf/`, "_blank");
  });
});

/* ===================== VISTA PREVIA (MODAL) ===================== */
const previewBtn       = document.getElementById('previewBtn');
const savePreviewBtn   = document.getElementById('savePreviewBtn');
const previewTableBody = document.querySelector('#previewTable tbody');
const mobilePreview    = document.getElementById('mobilePreviewContainer');
const previewTotal     = document.getElementById('previewTotal');
const msgErr           = document.getElementById('msgErr');

function getLinesFromMain() {
  const rows = [];
  tbody.querySelectorAll('tr').forEach(tr => {
    const ins = tr.querySelectorAll('input');
    const line = {
      ItemCode:        ins[0].value.trim(),
      ItemDescription: ins[1].value.trim(),
      Quantity:        Number(ins[2].value || 0),
      UnitPrice:       Number(ins[3].value || 0),
      WarehouseCode:   ins[4].value.trim(),
      U_GGH_TIM:       ins[5].value.trim(),
      TaxCode:         ins[6].value.trim()
    };
    if (line.ItemCode) rows.push(line);
  });
  return rows;
}

function clp(n){
  return Number(n||0).toLocaleString('es-CL',{style:'currency',currency:'CLP',maximumFractionDigits:0});
}

function calcTotals(lines){
  const neto = lines.reduce((a,l)=> a + (Number(l.Quantity)*Number(l.UnitPrice||0)), 0);
  const iva  = lines.reduce((a,l)=> {
    const ln = Number(l.Quantity)*Number(l.UnitPrice||0);
    return a + (/(^|\s)IVA/i.test(l.TaxCode) ? ln*0.19 : 0);
  }, 0);
  const total = neto + iva;
  previewTotal.innerHTML = `Neto: <b>${clp(neto)}</b> | IVA (19%): <b>${clp(iva)}</b> | Total: <b>${clp(total)}</b>`;
}

function bindRecalc(container){
  container.querySelectorAll('input').forEach(inp=>{
    inp.addEventListener('input', ()=>{
      const lines = collectLinesFromPreview();
      calcTotals(lines);
    });
  });
}

function renderPreviewDesktop(lines){
  previewTableBody.innerHTML = lines.map(l=>`
    <tr>
      <td><input value="${l.ItemCode}" readonly></td>
      <td><input value="${l.ItemDescription}"></td>
      <td><input type="number" min="1" step="1" value="${l.Quantity||1}"></td>
      <td><input type="number" min="0" step="0.01" value="${l.UnitPrice||0}"></td>
      <td><input value="${l.WarehouseCode||''}"></td>
      <td><input value="${l.U_GGH_TIM||''}"></td>
      <td><input value="${l.TaxCode||'IVA'}"></td>
    </tr>
  `).join('');
  bindRecalc(document.getElementById('previewTable'));
}

function renderPreviewMobile(lines){
  mobilePreview.innerHTML = lines.map(l=>`
    <div class="card mb-2">
      <div class="card-body">
        <div class="mb-2"><small class="text-muted">ItemCode</small><input class="form-control" value="${l.ItemCode}" readonly></div>
        <div class="mb-2"><small class="text-muted">Descripci√≥n</small><input class="form-control" value="${l.ItemDescription}"></div>
        <div class="mb-2"><small class="text-muted">Cantidad</small><input class="form-control" type="number" min="1" step="1" value="${l.Quantity||1}"></div>
        <div class="mb-2"><small class="text-muted">Precio Unitario</small><input class="form-control" type="number" min="0" step="0.01" value="${l.UnitPrice||0}"></div>
        <div class="mb-2"><small class="text-muted">Bodega</small><input class="form-control" value="${l.WarehouseCode||''}"></div>
        <div class="mb-2"><small class="text-muted">Entrega</small><input class="form-control" value="${l.U_GGH_TIM||''}"></div>
        <div><small class="text-muted">Impuesto</small><input class="form-control" value="${l.TaxCode||'IVA'}"></div>
      </div>
    </div>
  `).join('');
  bindRecalc(mobilePreview);
}

function collectLinesFromPreview(){
  const desktop = window.matchMedia('(min-width:768px)').matches;
  const lines = [];
  if (desktop){
    document.querySelectorAll('#previewTable tbody tr').forEach(tr=>{
      const ins = tr.querySelectorAll('input');
      lines.push({
        ItemCode:        ins[0].value.trim(),
        ItemDescription: ins[1].value.trim(),
        Quantity:        Number(ins[2].value||0),
        UnitPrice:       Number(ins[3].value||0),
        WarehouseCode:   ins[4].value.trim(),
        U_GGH_TIM:       ins[5].value.trim(),
        TaxCode:         ins[6].value.trim(),
      });
    });
  } else {
    mobilePreview.querySelectorAll('.card').forEach(card=>{
      const ins = card.querySelectorAll('input');
      lines.push({
        ItemCode:        ins[0].value.trim(),
        ItemDescription: ins[1].value.trim(),
        Quantity:        Number(ins[2].value||0),
        UnitPrice:       Number(ins[3].value||0),
        WarehouseCode:   ins[4].value.trim(),
        U_GGH_TIM:       ins[5].value.trim(),
        TaxCode:         ins[6].value.trim(),
      });
    });
  }
  return lines;
}

previewBtn.addEventListener('click', ()=>{
  msgErr.classList.add('d-none');
  const lines = getLinesFromMain();
  if (!lines.length){
    msgErr.textContent = "Debes agregar al menos una l√≠nea antes de la vista previa.";
    msgErr.classList.remove('d-none');
    return;
  }
  renderPreviewDesktop(lines);
  renderPreviewMobile(lines);
  calcTotals(lines);
  const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('previewModal'));
  modal.show();
});

savePreviewBtn.addEventListener('click', ()=>{
  const updated = collectLinesFromPreview();
  tbody.innerHTML = '';
  updated.forEach(l=>{
    addLineRow({
      Codigo:        l.ItemCode,
      ItemName:      l.ItemDescription,
      Quantity:      l.Quantity,
      UnitPrice:     l.UnitPrice,
      WarehouseCode: l.WarehouseCode,
      U_GGH_TIM:     l.U_GGH_TIM,
      TaxCode:       l.TaxCode
    });
  });
  const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('previewModal'));
  modal.hide();
});
</script>




{% endblock %}

