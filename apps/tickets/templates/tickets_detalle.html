{% extends "base.html" %}
{% load static %}
{% block content %}

<style>
.ticket-view{
  --bg:#f9fafb;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#6b7280;
  --border:#e5e7eb;
  --radius:10px;
  --shadow:0 2px 8px rgba(0,0,0,.05);
}
.ticket-header{
  background:linear-gradient(180deg,#fff 0%,#f9fafb 100%);
  border:1px solid var(--border);
  border-radius:var(--radius);
  padding:1rem 1.25rem;
  box-shadow:var(--shadow);
  margin-bottom:1rem;
}
.ticket-header__top{
  display:flex; justify-content:space-between; align-items:center;
  flex-wrap:wrap; gap:.8rem;
}
.ticket-title{ font-size:1.25rem; font-weight:700; color:var(--text); margin:0; }
.ticket-actions{ display:flex; align-items:center; gap:.5rem; flex-wrap:wrap; }
.ticket-actions .btn,
.ticket-actions .form-select{ border-radius:8px; }

/* Estado chip */
.chip{
  display:inline-flex; align-items:center; gap:.4rem;
  font-size:.8rem; font-weight:600;
  border-radius:999px; padding:.35rem .75rem;
}
.chip-open{ background:#fee2e2; color:#b91c1c; border:1px solid #fecaca; }
.chip-progress{ background:#fef3c7; color:#92400e; border:1px solid #fde68a; }
.chip-closed{ background:#f1f5f9; color:#334155; border:1px solid #cbd5e1; }

/* Metadata */
.ticket-meta{
  margin-top:.6rem; font-size:.9rem; color:var(--muted);
  display:flex; flex-wrap:wrap; gap:1.2rem;
}
.ticket-meta strong{ color:var(--text); }

/* Chat */
.chat-body {
  background:#ece5dd url("{% static 'img/chat-bg.png' %}") repeat;
  border-radius:8px; padding:1rem; min-height:400px;
}
.chat-container { display:flex; flex-direction:column; gap:.8rem; }
.chat-message {
  max-width:70%; padding:.6rem .9rem; border-radius:14px;
  font-size:.9rem; line-height:1.4; word-break:break-word;
  position:relative;
}
.chat-user {
  margin-left:auto; background:#dbeafe; color:#1e3a8a; border:1px solid #c7d2fe;
  border-bottom-right-radius:4px;
}
.chat-user::after {
  content:""; position:absolute; right:-10px; bottom:0;
  border-top:10px solid #dbeafe; border-left:10px solid transparent;
}
.chat-respuesta {
  margin-right:auto; background:#d4f8e8; color:#065f46; border:1px solid #a7f3d0;
  border-bottom-left-radius:4px;
}
.chat-respuesta::after {
  content:""; position:absolute; left:-10px; bottom:0;
  border-top:10px solid #d4f8e8; border-right:10px solid transparent;
}
.chat-meta { font-size:.75rem; color:var(--muted); margin-top:.25rem; text-align:right; }

/* Emoji picker */
.emoji-picker {
  position:absolute; bottom:120%; right:0; width:260px; max-height:200px;
  overflow-y:auto; z-index:1000;
}
.emoji-grid {
  display:flex; flex-wrap:wrap; gap:.3rem; font-size:1.4rem; cursor:pointer;
}
.emoji-grid span:hover { transform:scale(1.2); }

/* Responsive */
@media (max-width:768px){
  .ticket-header__top{ flex-direction:column; align-items:flex-start; }
  .ticket-actions{ width:100%; justify-content:space-between; }
  .chat-message{ max-width:85%; }
}
</style>

<div class="container py-4 ticket-view" style="max-width:1100px;">

  <!-- Header -->
  <div class="ticket-header">
    <div class="ticket-header__top">
      <h4 class="ticket-title">Ticket #{{ ticket.id }} — {{ ticket.titulo }}</h4>
      <div class="ticket-actions">
        <a href="{% url 'tickets_bandeja' %}" class="btn btn-outline-secondary btn-sm">← Bandeja</a>
        {% if puede_gestionar %}
        <form method="post" action="{% url 'tickets_cambiar_estado' ticket.id %}" class="d-flex align-items-center gap-2">
          {% csrf_token %}
          <select name="estado" class="form-select form-select-sm">
            {% for val,label in ticket.ESTADOS %}
              {% if val != 'resuelto' %}
                <option value="{{ val }}" {% if ticket.estado == val or ticket.estado == 'resuelto' and val == 'cerrado' %}selected{% endif %}>
                  {% if val == 'cerrado' and ticket.estado == 'resuelto' %}Cerrado{% else %}{{ label }}{% endif %}
                </option>
              {% endif %}
            {% endfor %}
          </select>
          <button class="btn btn-primary btn-sm">Actualizar</button>
        </form>
        {% endif %}
      </div>
    </div>
    <div class="mt-2">
      {% if ticket.estado == 'abierto' %}
        <span class="chip chip-open">Abierto</span>
      {% elif ticket.estado == 'en_progreso' %}
        <span class="chip chip-progress">En progreso</span>
      {% elif ticket.estado == 'cerrado' or ticket.estado == 'resuelto' %}
        <span class="chip chip-closed">Cerrado</span>
      {% endif %}
    </div>
    <div class="ticket-meta">
      <span>Creado: <strong>{{ ticket.fecha_creacion|date:"Y-m-d H:i" }}</strong></span>
      <span>Actualizado: <strong>{{ ticket.fecha_actualizacion|date:"Y-m-d H:i" }}</strong></span>
      <span>Solicitante: <strong>{{ ticket.solicitante.get_full_name|default:ticket.solicitante.username }}</strong></span>
    </div>
  </div>

  <!-- Conversación y respuesta -->
  <div class="row g-3 mt-3">
    <div class="col-lg-8">
      <div class="card">
        <div class="card-header">Conversación</div>
        <div class="chat-body">
          {% if mensajes %}
          <div class="chat-container">
            {% for m in mensajes %}
              <div class="chat-message {% if m.autor.id == user.id %}chat-user{% else %}chat-respuesta{% endif %}">
                <div>{{ m.mensaje|linebreaksbr }}</div>
                <div class="chat-meta">{{ m.autor.get_full_name|default:m.autor.username }} · {{ m.fecha|date:"Y-m-d H:i" }}</div>
              </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-muted">Sin mensajes aún.</p>
          {% endif %}

          {% if puede_responder %}
          <form method="post" enctype="multipart/form-data" class="mt-3 position-relative">
            {% csrf_token %}
            <div class="mb-2 position-relative">
              {{ form_msg.mensaje }}
              <button type="button" class="btn btn-light btn-sm position-absolute top-0 end-0 me-2 mt-2" id="btnEmoji">😀</button>
              <div id="emojiPicker" class="emoji-picker shadow-sm border bg-white p-2 rounded d-none">
                <div class="emoji-grid">
                  <span>😀</span><span>😃</span><span>😄</span><span>😁</span><span>😆</span>
                  <span>😂</span><span>😊</span><span>😉</span><span>😍</span><span>🤔</span>
                  <span>😢</span><span>😭</span><span>😡</span><span>😱</span><span>😴</span>
                  <span>👍</span><span>👎</span><span>👏</span><span>🙏</span><span>👌</span>
                  <span>❤️</span><span>💛</span><span>💚</span><span>💙</span><span>💜</span>
                </div>
              </div>
            </div>
            <div class="mb-3">
              {{ form_msg.archivos }}
              <div class="form-text">Puedes adjuntar archivos.</div>
            </div>
            <button class="btn btn-primary btn-sm">Enviar</button>
          </form>
          {% else %}
          <div class="alert alert-warning">Este ticket está <strong>cerrado</strong>. No se pueden agregar más mensajes ni adjuntos.</div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Adjuntos -->
    <div class="col-lg-4">
      <div class="card">
        <div class="card-header">Adjuntos</div>
        <div class="card-body">
          {% if adjuntos %}
          <ul class="list-group list-group-flush">
            {% for adj in adjuntos %}
            <li class="list-group-item d-flex justify-content-between align-items-center">
              <div>
                <div class="small">{{ adj.nombre }}</div>
                <div class="text-muted small">Subido por {{ adj.subido_por.get_full_name|default:adj.subido_por.username }}{% if adj.fecha_subida %} · {{ adj.fecha_subida|date:"Y-m-d H:i" }}{% endif %}</div>
              </div>
              <a class="btn btn-sm btn-outline-secondary" href="{% url 'tickets_adjunto_ver' adj.id %}" target="_blank">Ver</a>
            </li>
            {% endfor %}
          </ul>
          {% else %}
          <p class="text-muted">No hay adjuntos.</p>
          {% endif %}
        </div>
      </div>
    </div>
  </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", function(){
  const btn = document.getElementById("btnEmoji");
  const picker = document.getElementById("emojiPicker");
  const textarea = document.getElementById("id_mensaje");

  btn.addEventListener("click", (e) => {
    e.preventDefault();
    picker.classList.toggle("d-none");
  });
  picker.addEventListener("click", (e) => {
    if(e.target.tagName === "SPAN"){
      textarea.value += e.target.textContent;
      textarea.focus();
      picker.classList.add("d-none");
    }
  });
  document.addEventListener("click", (e) => {
    if(!picker.contains(e.target) && e.target !== btn){
      picker.classList.add("d-none");
    }
  });
});
</script>
{% endblock %}
