{% extends "base.html" %}
{% block content %}

<style>
/* ===== Look & feel de la bandeja ===== */
.tickets-ui{
  --bg:#f6f7f9;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#6b7280;
  --border:#e5e7eb;
  --border-strong:#cbd5e1;
  --primary:#0d6efd;
  --radius:10px;
  --radius-sm:8px;
  --shadow:0 6px 18px rgba(2,6,23,.06);
}

.tickets-ui *{ box-sizing:border-box; }
.tickets-ui h4{ margin:0; font-weight:700; color:var(--text); }

/* Header y panel de filtros */
.tickets-header{
  display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:12px;
  margin-bottom:14px;
}
.tickets-header .badge-count{
  font-weight:600; color:#334155; background:#eef2f7; border:1px solid #d7dce3; border-radius:999px;
  padding:.25rem .6rem; font-size:.75rem; letter-spacing:.2px;
}

.filter-card{
  background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow);
  padding:10px 12px; margin-bottom:16px;
}
.filter-row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
.filter-row .input-group-text{ background:#f8fafc; border-color:var(--border-strong); }
.filter-row .form-control,
.filter-row .form-select{
  border:1px solid var(--border-strong); border-radius:var(--radius-sm);
}
.filter-row .btn{ border-radius:8px; }

/* Tabla */
.table-frame{
  background:var(--card); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow);
}
.table thead th{
  background:#f8fafc; color:#334155; font-weight:700; border-bottom:1px solid var(--border);
}
.table tbody td{
  border-top:1px solid var(--border);
}
.cell-title .title{
  max-width:520px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:600; color:#0f172a;
}
.cell-sub{
  font-size:.85rem; color:var(--muted);
}

/* Badges de estado */
.status{
  display:inline-flex; align-items:center; gap:.4rem; padding:.25rem .55rem; border-radius:999px;
  font-size:.75rem; font-weight:700; letter-spacing:.2px; border:1px solid transparent;
}
.status .dot{ width:8px; height:8px; border-radius:50%; display:inline-block; }

.status-open{ color:#b91c1c; background:#fff1f2; border-color:#fecaca; }
.status-open .dot{ background:#ef4444; }

.status-progress{ color:#b45309; background:#fff7ed; border-color:#fed7aa; }
.status-progress .dot{ background:#f59e0b; }

.status-done{ color:#065f46; background:#ecfdf5; border-color:#a7f3d0; }
.status-done .dot{ background:#10b981; }

.status-closed{ color:#334155; background:#f1f5f9; border-color:#cbd5e1; }
.status-closed .dot{ background:#64748b; }

/* Botones */
.table .btn{ border-radius:8px; }

/* Empty state */
.empty{
  padding:36px 16px; color:var(--muted);
}
.empty .emoji{ font-size:2rem; line-height:1; }

/* Responsivo */
@media (max-width: 768px){
  .cell-title .title{ max-width:360px; }
}
</style>

<div class="container py-4 tickets-ui">

  <!-- Header -->
  <div class="tickets-header">
    <div class="d-flex align-items-center gap-2">
      <h4 class="mb-0">Bandeja de tickets</h4>
      {% if tickets %}
        <span class="badge-count">{{ tickets|length }} en total</span>
      {% endif %}
    </div>
  </div>

  <!-- Filtros -->
  <div class="filter-card">
    <form class="filter-row" method="get" role="search" aria-label="Filtro de tickets">
      <div class="input-group" style="min-width:260px;">
        <span class="input-group-text" id="ico-search" aria-hidden="true">ðŸ”Ž</span>
        <input name="q" value="{{ q }}" class="form-control" placeholder="Buscar por tÃ­tulo o descripciÃ³n..." aria-label="Buscar" aria-describedby="ico-search">
      </div>

      <select name="estado" class="form-select" aria-label="Filtrar por estado">
        <option value="">Todos los estados</option>
        <option value="abierto"      {% if f_estado == 'abierto' %}selected{% endif %}>Abierto</option>
        <option value="en_progreso"  {% if f_estado == 'en_progreso' %}selected{% endif %}>En progreso</option>
        <option value="resuelto"     {% if f_estado == 'resuelto' %}selected{% endif %}>Resuelto</option>
        <option value="cerrado"      {% if f_estado == 'cerrado' %}selected{% endif %}>Cerrado</option>
      </select>

      <div class="form-check ms-1">
        <input class="form-check-input" type="checkbox" value="1" id="chkAbiertos" name="abiertos"
               {% if solo_abiertos == '1' %}checked{% endif %}>
        <label class="form-check-label" for="chkAbiertos">Solo abiertos</label>
      </div>

      <button class="btn btn-primary">Filtrar</button>
      <a class="btn btn-light border" href="{% url 'tickets_bandeja' %}">Limpiar</a>
    </form>
  </div>

  <!-- Lista -->
  <div class="table-frame">
    {% if tickets %}
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead>
            <tr>
              <th style="width:80px;">#</th>
              <th>TÃ­tulo</th>
              <th style="width:210px;">Solicitante</th>
              <th style="width:140px;">Estado</th>
              <th style="width:160px;">Actualizado</th>
              <th style="width:130px;"></th>
            </tr>
          </thead>
          <tbody>
            {% for t in tickets %}
            <tr>
              <td class="text-muted">#{{ t.id }}</td>

              <td class="cell-title">
                <div class="title" title="{{ t.titulo }}">{{ t.titulo }}</div>
              </td>

              <td>
                {% if t.solicitante %}
                  {{ t.solicitante.get_full_name|default:t.solicitante.username }}
                {% else %}
                  <span class="text-muted">â€”</span>
                {% endif %}
              </td>

              <td>
                {% if t.estado == 'abierto' %}
                  <span class="status status-open"><span class="dot"></span> Abierto</span>
                {% elif t.estado == 'en_progreso' or t.estado == 'en-progreso' %}
                  <span class="status status-progress"><span class="dot"></span> En progreso</span>
                {% elif t.estado == 'resuelto' %}
                  <span class="status status-done"><span class="dot"></span> Resuelto</span>
                {% elif t.estado == 'cerrado' %}
                  <span class="status status-closed"><span class="dot"></span> Cerrado</span>
                {% else %}
                  <span class="status">{{ t.get_estado_display }}</span>
                {% endif %}
              </td>

              <td class="text-nowrap">
                {{ t.fecha_actualizacion|date:"Y-m-d H:i" }}
              </td>

              <td class="text-end">
                <a href="{% url 'tickets_detalle' t.id %}"
                   class="btn btn-sm btn-outline-primary"
                   aria-label="Abrir ticket #{{ t.id }}">
                  Ver
                </a>
              </td>

            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <div class="empty text-center">
        <div class="emoji mb-2">ðŸ“­</div>
        No hay tickets que coincidan con el filtro.
      </div>
    {% endif %}
  </div>

</div>
{% endblock %}
