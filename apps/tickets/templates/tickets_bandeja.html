{% extends "base.html" %}
{% block content %}

<style>
.tickets-ui{
  --bg:#f6f7f9; --card:#ffffff; --text:#0f172a;
  --muted:#6b7280; --border:#e5e7eb; --border-strong:#cbd5e1;
  --primary:#0d6efd; --radius:10px; --radius-sm:8px;
  --shadow:0 6px 18px rgba(2,6,23,.06);
}
.tickets-ui *{ box-sizing:border-box; }
.tickets-ui h4{ margin:0; font-weight:700; color:var(--text); }

.tickets-header{ display:flex; flex-wrap:wrap; align-items:center; justify-content:space-between; gap:12px; margin-bottom:14px; }
.tickets-header .badge-count{ font-weight:600; color:#334155; background:#eef2f7; border:1px solid #d7dce3; border-radius:999px; padding:.25rem .6rem; font-size:.75rem; }

.filter-card{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:10px 12px; margin-bottom:16px; }
.filter-row{ display:flex; flex-wrap:wrap; gap:10px; align-items:center; }
.filter-row .input-group-text{ background:#f8fafc; border-color:var(--border-strong); }
.filter-row .form-control,.filter-row .form-select{ border:1px solid var(--border-strong); border-radius:var(--radius-sm); }
.filter-row .btn{ border-radius:8px; }

.table-frame{ background:var(--card); border:1px solid var(--border); border-radius:var(--radius); overflow:hidden; box-shadow:var(--shadow); }
.table thead th{ background:#f8fafc; color:#334155; font-weight:700; border-bottom:1px solid var(--border); white-space:nowrap; }
.table tbody td{ border-top:1px solid var(--border); vertical-align:middle; }

.cell-title .title{ max-width:520px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; font-weight:600; color:#0f172a; }

.status{ display:inline-flex; align-items:center; gap:.4rem; padding:.25rem .55rem; border-radius:999px; font-size:.75rem; font-weight:700; border:1px solid transparent; white-space:nowrap; }
.status .dot{ width:8px; height:8px; border-radius:50%; display:inline-block; }
.status-open{ color:#b91c1c; background:#fff1f2; border-color:#fecaca; }
.status-open .dot{ background:#ef4444; }
.status-progress{ color:#b45309; background:#fff7ed; border-color:#fed7aa; }
.status-progress .dot{ background:#f59e0b; }
.status-closed{ color:#334155; background:#f1f5f9; border-color:#cbd5e1; }
.status-closed .dot{ background:#64748b; }

.empty{ padding:36px 16px; color:var(--muted); }
.empty .emoji{ font-size:2rem; }

/* ===== Mobile view (cards en vez de tabla) ===== */
@media (max-width: 991px){
  .table-frame{ display:none; } /* ocultar tabla */
  .tickets-cards{ display:grid; gap:1rem; }
  .ticket-card{
    background:#fff; border:1px solid var(--border); border-radius:var(--radius);
    padding:1rem; box-shadow:var(--shadow);
  }
  .ticket-card h6{ font-size:1rem; font-weight:600; margin:0 0 .5rem; color:#0f172a; }
  .ticket-card .meta{ font-size:.85rem; color:var(--muted); margin-bottom:.4rem; }
  .ticket-card .status{ margin-top:.3rem; }
  .ticket-card .actions{ margin-top:.8rem; text-align:right; }
}
</style>

<div class="container py-4 tickets-ui">
  <div class="tickets-header">
    <div class="d-flex align-items-center gap-2">
      <h4 class="mb-0">Bandeja de tickets</h4>
      {% if tickets %}<span class="badge-count">{{ tickets|length }} en total</span>{% endif %}
    </div>
  </div>

  <div class="filter-card">
    <form class="filter-row" method="get">
      <div class="input-group flex-grow-1">
        <span class="input-group-text">ðŸ”Ž</span>
        <input name="q" value="{{ q }}" class="form-control" placeholder="Buscar...">
      </div>
      <select name="estado" class="form-select">
        <option value="">Todos</option>
        <option value="abierto" {% if f_estado == 'abierto' %}selected{% endif %}>Abierto</option>
        <option value="en_progreso" {% if f_estado == 'en_progreso' or f_estado == 'en-progreso' %}selected{% endif %}>En progreso</option>
        <option value="cerrado" {% if f_estado == 'cerrado' or f_estado == 'resuelto' %}selected{% endif %}>Cerrado</option>
      </select>
      <div class="form-check">
        <input class="form-check-input" type="checkbox" value="1" id="chkAbiertos" name="abiertos" {% if solo_abiertos == '1' %}checked{% endif %}>
        <label class="form-check-label" for="chkAbiertos">Solo abiertos</label>
      </div>
      <div class="d-flex gap-2 w-100 w-md-auto">
        <button class="btn btn-primary w-100 w-md-auto">Filtrar</button>
        <a class="btn btn-light border w-100 w-md-auto" href="{% url 'tickets_bandeja' %}">Limpiar</a>
      </div>
    </form>
  </div>

  <!-- ===== Tabla (desktop) ===== -->
  <div class="table-frame">
    {% if tickets %}
    <div class="table-responsive">
      <table class="table table-hover align-middle mb-0">
        <thead>
          <tr><th>#</th><th>TÃ­tulo</th><th>Solicitante</th><th>Estado</th><th>Actualizado</th><th></th></tr>
        </thead>
        <tbody>
          {% for t in tickets %}
          <tr>
            <td>#{{ t.id }}</td>
            <td class="cell-title"><div class="title">{{ t.titulo }}</div></td>
            <td>{{ t.solicitante.get_full_name|default:t.solicitante.username }}</td>
            <td>
              {% if t.estado == 'abierto' %}
                <span class="status status-open"><span class="dot"></span> Abierto</span>
              {% elif t.estado == 'en_progreso' or t.estado == 'en-progreso' %}
                <span class="status status-progress"><span class="dot"></span> En progreso</span>
              {% elif t.estado == 'cerrado' or t.estado == 'resuelto' %}
                <span class="status status-closed"><span class="dot"></span> Cerrado</span>
              {% endif %}
            </td>
            <td>{{ t.fecha_actualizacion|date:"Y-m-d H:i" }}</td>
            <td class="text-end"><a href="{% url 'tickets_detalle' t.id %}" class="btn btn-sm btn-outline-primary">Ver</a></td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    {% else %}
      <div class="empty text-center"><div class="emoji mb-2">ðŸ“­</div>No hay tickets.</div>
    {% endif %}
  </div>

  <!-- ===== Cards (mÃ³vil) ===== -->
  <div class="tickets-cards d-lg-none">
    {% if tickets %}
      {% for t in tickets %}
      <div class="ticket-card">
        <h6>#{{ t.id }} â€” {{ t.titulo }}</h6>
        <div class="meta">Solicitante: {{ t.solicitante.get_full_name|default:t.solicitante.username }}</div>
        <div class="meta">Actualizado: {{ t.fecha_actualizacion|date:"Y-m-d H:i" }}</div>
        {% if t.estado == 'abierto' %}
          <span class="status status-open"><span class="dot"></span> Abierto</span>
        {% elif t.estado == 'en_progreso' or t.estado == 'en-progreso' %}
          <span class="status status-progress"><span class="dot"></span> En progreso</span>
        {% elif t.estado == 'cerrado' or t.estado == 'resuelto' %}
          <span class="status status-closed"><span class="dot"></span> Cerrado</span>
        {% endif %}
        <div class="actions">
          <a href="{% url 'tickets_detalle' t.id %}" class="btn btn-sm btn-primary">Ver</a>
        </div>
      </div>
      {% endfor %}
    {% else %}
      <div class="empty text-center"><div class="emoji mb-2">ðŸ“­</div>No hay tickets.</div>
    {% endif %}
  </div>
</div>
{% endblock %}
