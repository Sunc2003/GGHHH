{% extends "base.html" %}
{% block content %}
{% load permisos_tags %}
<div class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h4>Tickets</h4>

       {% if request.user|tiene_permiso:"TICKETS_CREAR" %}
      <a class="btn btn-primary btn-sm" href="{% url 'tickets_crear' %}">+ Nuevo ticket</a>
    {% endif %}
  </div>

  <form class="row g-2 mb-3" method="get">
    <div class="col-sm-4">
      <input name="q" value="{{ q }}" class="form-control" placeholder="Buscar...">
    </div>
    <div class="col-sm-3">
      <select name="estado" class="form-select">
        <option value="">Todos los estados</option>
        <option value="abierto" {% if f_estado == 'abierto' %}selected{% endif %}>Abierto</option>
        <option value="en_progreso" {% if f_estado == 'en_progreso' %}selected{% endif %}>En progreso</option>
        <option value="resuelto" {% if f_estado == 'resuelto' %}selected{% endif %}>Resuelto</option>
        <option value="cerrado" {% if f_estado == 'cerrado' %}selected{% endif %}>Cerrado</option>
      </select>
    </div>

    {# Estos dos filtros solo tienen sentido para agentes; si quieres, escóndelos con es_agente #}
    {% if es_agente %}
    <div class="col-sm-2">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="propios" value="1" id="chk-propios" {% if propios == '1' %}checked{% endif %}>
        <label class="form-check-label" for="chk-propios">Mis tickets</label>
      </div>
    </div>
    <div class="col-sm-3">
      <div class="form-check">
        <input class="form-check-input" type="checkbox" name="asignados" value="1" id="chk-asignados" {% if asignados == '1' %}checked{% endif %}>
        <label class="form-check-label" for="chk-asignados">Asignados a mí</label>
      </div>
    </div>
    {% endif %}
  </form>

  <div class="table-responsive">
    <table class="table table-hover align-middle">
      <thead class="table-light">
        <tr>
          <th>#</th>
          <th>Título</th>
          <th>Estado</th>
          <th>Prioridad</th>
          <th>Solicitante</th>
          <th>Asignado a</th>
          <th>Actualizado</th>
        </tr>
      </thead>
      <tbody>
        {% for t in tickets %}
          <tr>
            <td>#{{ t.id }}</td>
            <td><a href="{% url 'tickets_detalle' t.id %}">{{ t.titulo }}</a></td>
            <td><span class="badge bg-secondary">{{ t.get_estado_display }}</span></td>
            <td><span class="badge bg-info text-dark">{{ t.get_prioridad_display }}</span></td>
            <td>{{ t.solicitante }}</td>
            <td>{{ t.asignado_a|default:"—" }}</td>
            <td>{{ t.fecha_actualizacion|date:"Y-m-d H:i" }}</td>
          </tr>
        {% empty %}
          <tr><td colspan="7" class="text-center text-muted">Sin resultados</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
