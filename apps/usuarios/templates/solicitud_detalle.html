{% extends "base.html" %}
{% load static %}
{% load custom_filters %}
 
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/solicitud_detalle.css' %}">
<style>
  .card-detalle {
    background: #fff;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 1.2rem;
    margin-bottom: 1.5rem;
    box-shadow: 0 2px 6px rgba(0,0,0,.05);
    width: 95%;
    max-width: none;
  }
  
  legend{font-size:1.2rem;font-weight:bold;padding:0 6px;color:#444;}
  .table th,.table td{vertical-align:middle;font-size:.95rem;text-align:center;}
  img.img-preview{max-width:120px;margin:4px;border-radius:6px;border:1px solid #ddd;}
  .adjuntos-grid{display:flex;flex-wrap:wrap;gap:10px;}
 
  .copy-wrap{display:inline-flex;align-items:center;gap:.4rem;justify-content:center;}
  .copy-text{display:inline-block;max-width:18ch;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;vertical-align:middle;}
  .copy-btn{--btn-bd:#dee2e6;--btn-bg:#f8f9fa;--btn-tx:#212529;padding:.2rem .45rem;border:1px solid var(--btn-bd);background:var(--btn-bg);color:var(--btn-tx);border-radius:.35rem;font-size:.75rem;line-height:1;}
  .copy-btn:hover{background:#eef1f3;}
  .copy-btn.copied{background:#d1e7dd;border-color:#bcd0c7;}
  .copy-btn i{font-size:.85em;}
 
  .table-responsive{overflow-x:auto;}
  .table{width:100%;min-width:900px;}
  @media (max-width:768px){ .copy-text{max-width:12ch;} }
 
  .table.table-striped.table-bordered { width: 100%; min-width: 2000px; }
  .table.table-striped.table-bordered th,
  .table.table-striped.table-bordered td {
    padding: 0.8rem 1.5rem;
    font-size: 0.95rem;
    white-space: nowrap;
    text-align: left;
  }
</style>
{% endblock %}
 
{% block content %}
 
  <h2 class="mb-4 text-center">
    <i class="fas fa-barcode"></i> DETALLE DE SOLICITUD DE CÓDIGO SAP
  </h2>
 
  <!-- Información General -->
  <fieldset class="card-detalle">
    <legend>Información General</legend>
    <div class="row g-3">
      <div class="col-md-6">
        <p><strong>Tipo de Solicitud:</strong> {{ object.get_tipo_solicitud_display|default:"-"|upper }}</p>
        <p><strong>Solicitado por:</strong> {{ object.solicitante|default:"-"|upper }}</p>
        <p><strong>Empresa:</strong> {{ object.get_empresa_display|default:"-"|upper }}</p>

        {% if object.tipo_solicitud != "activacion" and object.tipo_solicitud != "modificacion" %}
          <p><strong>Tipo de Cotización:</strong> {{ object.get_cotizacion_display|default:"-"|upper }}</p>
        {% endif %}

        {% if object.tipo_solicitud == "activacion" or object.tipo_solicitud == "modificacion" %}
          <p><strong>Código:</strong>
            <span class="copy-wrap">
              <span class="copy-text">{{ object.codigo_extra|default:"-"|upper }}</span>
              <button type="button" class="copy-btn"><i class="fa-regular fa-copy"></i></button>
            </span>
          </p>
        {% endif %}
      </div>
 
      <div class="col-md-6">
        {% with adjuntos=object.adjuntos.all %}
          {% if adjuntos %}
            <p><strong>Documentos:</strong></p>
            <ul>
              {% for doc in adjuntos %}
                {% if doc.tipo == 'documento' %}
                  <li>📄
                    <a href="https://otjcliklurucbuvqzxdg.supabase.co/storage/v1/object/public/media/{{ doc.archivo.name }}" target="_blank">
                      {{ doc.archivo.name|slice:"-50:"|upper }}
                    </a>
                  </li>
                {% endif %}
              {% endfor %}
            </ul>
 
            <p class="mt-3"><strong>Imágenes WhatsApp:</strong></p>
            <div class="adjuntos-grid">
              {% for img in adjuntos %}
                {% if img.tipo == 'imagen' %}
                  <a href="https://otjcliklurucbuvqzxdg.supabase.co/storage/v1/object/public/media/{{ img.archivo.name }}" target="_blank">
                    <img src="https://otjcliklurucbuvqzxdg.supabase.co/storage/v1/object/public/media/{{ img.archivo.name }}" alt="Imagen" class="img-preview">
                  </a>
                {% endif %}
              {% endfor %}
            </div>
          {% else %}
            <div class="text-muted">NO HAY ADJUNTOS PARA ESTA SOLICITUD.</div>
          {% endif %}
        {% endwith %}
      </div>
    </div>
 
    {% if object.mensaje %}
      <div class="mt-3">
        <p><strong>Mensaje:</strong></p>
        <div class="alert alert-secondary p-2">{{ object.mensaje|default:"-"|upper|linebreaks }}</div>
      </div>
    {% endif %}
  </fieldset>
 
  <!-- Tabla de Productos (solo si no es activación ni modificación) -->
  {% if object.tipo_solicitud != "activacion" and object.tipo_solicitud != "modificacion" %}
    {% if productos %}
    <fieldset class="card-detalle">
      <legend>Productos Asociados</legend>
      <div class="table-responsive">
        <table class="table table-striped table-bordered">
          <thead class="table-light">
            <tr>
              <th>Descripción</th>
              <th>Marca</th>
              <th>UDM</th>
              <th>Origen</th>
              <th>Proveedor</th>
              <th>Largo (cm)</th>
              <th>Ancho (cm)</th>
              <th>Alto (cm)</th>
              <th>Peso (kg)</th>
              <th>Costo</th>
              <th>PMV</th>
              <th>PVP</th>
              <th>SKU Proveedor</th>
              <th>SKU Fabricante</th>
            </tr>
          </thead>
          <tbody>
            {% for p in productos %}
            <tr>
              <td><span class="copy-wrap"><span class="copy-text">{{ p.producto.descripcion|upper }}</span><button type="button" class="copy-btn"><i class="fa-regular fa-copy"></i></button></span></td>
              <td><span class="copy-wrap"><span class="copy-text">{{ p.producto.marca|upper }}</span><button type="button" class="copy-btn"><i class="fa-regular fa-copy"></i></button></span></td>
              <td><span class="copy-wrap"><span class="copy-text">{{ p.producto.udm|upper }}</span><button type="button" class="copy-btn"><i class="fa-regular fa-copy"></i></button></span></td>
              <td><span class="copy-wrap"><span class="copy-text">{{ p.producto.get_origen_display|upper }}</span><button type="button" class="copy-btn"><i class="fa-regular fa-copy"></i></button></span></td>
              <td><span class="copy-wrap"><span class="copy-text">{{ p.producto.proveedor|upper }}</span><button type="button" class="copy-btn"><i class="fa-regular fa-copy"></i></button></span></td>
              <td><span class="copy-wrap"><span class="copy-text">{{ p.producto.largo }}</span><button type="button" class="copy-btn"><i class="fa-regular fa-copy"></i></button></span></td>
              <td><span class="copy-wrap"><span class="copy-text">{{ p.producto.ancho }}</span><button type="button" class="copy-btn"><i class="fa-regular fa-copy"></i></button></span></td>
              <td><span class="copy-wrap"><span class="copy-text">{{ p.producto.alto }}</span><button type="button" class="copy-btn"><i class="fa-regular fa-copy"></i></button></span></td>
              <td><span class="copy-wrap"><span class="copy-text">{{ p.producto.peso }}</span><button type="button" class="copy-btn"><i class="fa-regular fa-copy"></i></button></span></td>
              <td><span class="copy-wrap"><span class="copy-text">${{ p.producto.costo }}</span><button type="button" class="copy-btn"><i class="fa-regular fa-copy"></i></button></span></td>
              <td><span class="copy-wrap"><span class="copy-text">{% if p.pmv %}${{ p.pmv|floatformat:2 }}{% else %}-{% endif %}</span><button type="button" class="copy-btn"><i class="fa-regular fa-copy"></i></button></span></td>
              <td><span class="copy-wrap"><span class="copy-text">{% if p.pvp %}${{ p.pvp|floatformat:2 }}{% else %}-{% endif %}</span><button type="button" class="copy-btn"><i class="fa-regular fa-copy"></i></button></span></td>
              <td><span class="copy-wrap"><span class="copy-text">{{ p.producto.sku_proveedor|upper }}</span><button type="button" class="copy-btn"><i class="fa-regular fa-copy"></i></button></span></td>
              <td><span class="copy-wrap"><span class="copy-text">{{ p.producto.sku_fabricante|upper }}</span><button type="button" class="copy-btn"><i class="fa-regular fa-copy"></i></button></span></td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </fieldset>
    {% else %}
      <div class="alert alert-warning text-center">
        <i class="fas fa-info-circle"></i> ESTA SOLICITUD NO TIENE PRODUCTOS ASOCIADOS.
      </div>
    {% endif %}
  {% endif %}
 
  <!-- Estado de la Solicitud -->
  <fieldset class="card-detalle">
    <legend>Estado de la Solicitud</legend>
    <p><strong>Estado actual:</strong>
      <span class="badge {% if object.estado == 'pendiente' %}bg-warning text-dark{% else %}bg-success{% endif %}">
        {{ object.get_estado_display|upper }}
      </span>
    </p>
 
    {% if request.user == object.receptor and object.estado == 'pendiente' %}
    <form method="post" action="{% url 'cambiar_estado' object.pk %}">
      {% csrf_token %}
      {{ form.non_field_errors }}
      <div class="mb-3">{{ form.comentario_estado.label_tag }}{{ form.comentario_estado }}</div>
      <button type="submit" class="btn btn-success">
        <i class="fas fa-check-circle"></i> MARCAR COMO "CÓDIGO CREADO"
      </button>
    </form>
    {% endif %}
  </fieldset>
 
</div>
 
<script>
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('.copy-btn');
    if (!btn) return;
    const textEl = btn.parentElement.querySelector('.copy-text');
    if (!textEl) return;
    const value = (textEl.innerText || '').trim();
    try {
      await navigator.clipboard.writeText(value);
      const original = btn.innerHTML;
      btn.classList.add('copied'); btn.innerHTML = 'Copiado';
      setTimeout(() => { btn.classList.remove('copied'); btn.innerHTML = original; }, 1200);
    } catch {
      const area = document.createElement('textarea');
      area.value = value; area.style.position = 'fixed'; area.style.left = '-9999px';
      document.body.appendChild(area); area.select(); document.execCommand('copy'); document.body.removeChild(area);
      const original = btn.innerHTML;
      btn.classList.add('copied'); btn.innerHTML = 'Copiado';
      setTimeout(() => { btn.classList.remove('copied'); btn.innerHTML = original; }, 1200);
    }
  });
</script>
{% endblock %}
