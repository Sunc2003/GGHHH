{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/solicitud_form.css' %}">
<style>
  .btn-solicitar-codigo {
    background:#232323;color:#fff!important;border:2px solid #232323;
    border-radius:0.25rem;font-weight:700;letter-spacing:0.43px;
    padding:0.8rem 2.6rem;font-size:1.12rem;
    box-shadow:0 1.5px 8px rgba(40,40,40,0.10);transition:background 0.15s;
  }
  .btn-solicitar-codigo:hover {background:#000;border-color:#000;}
  .formset-form {
    border-left:5px solid #007bff;background-color:#f9f9f9;
    padding:1rem;margin-bottom:1rem;border-radius:5px;
  }
  .tabla-productos th,.tabla-productos td {font-size:0.9rem;vertical-align:middle;}
  .tabla-productos .btn {padding:0.1rem 0.4rem;font-size:0.8rem;}
  .error-msg {color:#d9534f;font-size:0.85rem;margin-top:3px;}
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
  <div id="menu-botones" class="mb-4 d-flex flex-wrap gap-3">
    <button id="btn-mostrar-form" class="btn-solicitar-codigo">Solicitar Código</button>
    <button id="btn-mostrar-enviadas" class="btn-solicitar-codigo">Solicitudes Enviadas</button>
    <a href="{% url 'solicitudes_recibidas' %}" class="btn-solicitar-codigo">
      <i class="fas fa-inbox"></i> Ver Solicitudes Recibidas
    </a>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-danger{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <div id="formulario-container" style="display:none;">
    <h2 class="mb-4"><i class="fas fa-barcode"></i> Nueva Solicitud de Código SAP</h2>
    <form method="post" enctype="multipart/form-data" id="solicitud-form">
      {% csrf_token %}
      <fieldset class="border p-3 mb-4">
        <legend>Información General</legend>
        <div class="row g-3">
          <div class="col-md-4">
            {{ form.receptor.label_tag }}{{ form.receptor }}
            {% for error in form.receptor.errors %}<div class="error-msg">{{ error }}</div>{% endfor %}
          </div>
          <div class="col-md-4">
            {{ form.empresa.label_tag }}{{ form.empresa }}
            {% for error in form.empresa.errors %}<div class="error-msg">{{ error }}</div>{% endfor %}
          </div>
          <div class="col-md-4">
            {{ form.tipo_solicitud.label_tag }}{{ form.tipo_solicitud }}
            {% for error in form.tipo_solicitud.errors %}<div class="error-msg">{{ error }}</div>{% endfor %}
          </div>
          <div class="col-md-4">
            {{ form.cotizacion.label_tag }}{{ form.cotizacion }}
            {% for error in form.cotizacion.errors %}<div class="error-msg">{{ error }}</div>{% endfor %}
          </div>
          
          <!-- Nuevos campos múltiples -->
          <div class="col-md-6" id="campo_archivo" style="display:none;">
            {{ form.archivos.label_tag }}{{ form.archivos }}
            <small class="text-muted">Puedes seleccionar varios archivos</small>
            {% for error in form.archivos.errors %}<div class="error-msg">{{ error }}</div>{% endfor %}
          </div>
          <div class="col-md-6" id="campo_imagen" style="display:none;">
            {{ form.imagenes.label_tag }}{{ form.imagenes }}
            <small class="text-muted">Puedes seleccionar varias imágenes</small>
            {% for error in form.imagenes.errors %}<div class="error-msg">{{ error }}</div>{% endfor %}
          </div>
        </div>
      </fieldset>

      <!-- Tabla de productos -->
      <fieldset class="border p-3 mb-4">
        <legend>Productos Agregados</legend>
        <div class="table-responsive">
          <table class="table table-striped tabla-productos" id="tabla-detalles">
            <thead>
              <tr>
                <th>#</th>
                <th>Descripción</th>
                <th>Marca</th>
                <th>UDM</th>
                <th>Origen</th>
                <th>Proveedor</th>
                <th>Dimensiones</th>
                <th>Peso</th>
                <th>Costo</th>
                <th>SKU Prov.</th>
                <th>SKU Fab.</th>
                <th></th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </fieldset>

      <!-- Formulario visible para agregar productos -->
      <fieldset class="border p-3 mb-4">
        <legend>Agregar Producto</legend>
        <div class="formset-form" id="formset-actual">
          {% for field in formset.empty_form.visible_fields %}
            <div class="mb-2">
              {{ field.label_tag }}{{ field }}
              {% for error in field.errors %}<div class="error-msg">{{ error }}</div>{% endfor %}
            </div>
          {% endfor %}
        </div>
        {{ formset.management_form }}
        <button type="button" class="btn btn-outline-primary mt-2" id="add-product-btn">
          + Agregar Producto
        </button>
      </fieldset>

      <!-- Mensaje -->
      <fieldset class="border p-3 mb-4">
        <legend>Mensaje</legend>
        <div class="mb-3">
          {{ form.mensaje.label_tag }}{{ form.mensaje }}
          {% for error in form.mensaje.errors %}<div class="error-msg">{{ error }}</div>{% endfor %}
        </div>
      </fieldset>

      <div class="d-flex justify-content-start">
        <button type="submit" class="btn btn-success me-2">Enviar Solicitud</button>
      </div>
    </form>
  </div>

  <!-- Solicitudes enviadas -->
  <div id="solicitudes-enviadas" style="display:none;">
    <h3>Solicitudes Enviadas</h3>
    <table class="table table-hover">
      <thead><tr><th>#</th><th>Empresa</th><th>Tipo</th><th>Estado</th><th>Fecha</th><th></th></tr></thead>
      <tbody>
        {% for s in solicitudes_enviadas %}
        <tr>
          <td>{{ forloop.counter }}</td>
          <td>{{ s.get_empresa_display }}</td>
          <td>{{ s.get_tipo_solicitud_display }}</td>
          <td>{{ s.get_estado_display }}</td>
          <td>{{ s.fecha_creacion|date:"d-m-Y H:i" }}</td>
          <td><a href="{% url 'detalle_solicitud' s.id %}" class="btn btn-sm btn-outline-primary">Ver</a></td>
        </tr>
        {% empty %}
        <tr><td colspan="6" class="text-center">No has enviado solicitudes aún.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- JS dinámico -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const menu = document.getElementById('menu-botones');
  const formContainer = document.getElementById('formulario-container');
  const solicitudesContainer = document.getElementById('solicitudes-enviadas');
  const cotSelect = document.getElementById('id_cotizacion');
  const campoArchivo = document.getElementById('campo_archivo');
  const campoImagen = document.getElementById('campo_imagen');
  const tabla = document.querySelector('#tabla-detalles tbody');
  const addBtn = document.getElementById('add-product-btn');
  const totalForms = document.getElementById('id_form-TOTAL_FORMS');
  let index = parseInt(totalForms.value);

  document.getElementById('btn-mostrar-form').onclick = () => {
    formContainer.style.display='block';
    solicitudesContainer.style.display='none';
    menu.style.display='none';
  };
  document.getElementById('btn-mostrar-enviadas').onclick = () => {
    formContainer.style.display='none';
    solicitudesContainer.style.display='block';
    menu.style.display='none';
  };

  if(cotSelect){
    cotSelect.addEventListener('change', () => {
      const val = cotSelect.value;
      campoArchivo.style.display = val === 'documento' ? 'block' : 'none';
      campoImagen.style.display = val === 'whatsapp' ? 'block' : 'none';
    });
    cotSelect.dispatchEvent(new Event('change'));
  }

  addBtn.addEventListener('click', () => {
    const currentForm = document.querySelector('#formset-actual');
    const inputs = currentForm.querySelectorAll('input, select, textarea');
    const producto = {};
    let valido = true;

    inputs.forEach(input => {
      if (!input.value && input.required !== false) {
        input.classList.add('is-invalid');
        valido = false;
      } else {
        input.classList.remove('is-invalid');
        producto[input.name.split('-')[2]] = input.value;
      }
    });
    if (!valido) return;

    const marcaTexto = currentForm.querySelector('select[name$="-marca"]')?.selectedOptions[0].text || '';
    const udmTexto = currentForm.querySelector('select[name$="-udm"]')?.selectedOptions[0].text || '';
    const origenTexto = currentForm.querySelector('select[name$="-origen"]')?.selectedOptions[0].text || '';
    const proveedorTexto = currentForm.querySelector('select[name$="-proveedor"]')?.selectedOptions[0].text || '';

    const fila = document.createElement('tr');
    fila.innerHTML = `
      <td>${index+1}</td>
      <td>${producto.descripcion}</td>
      <td>${marcaTexto}</td>
      <td>${udmTexto}</td>
      <td>${origenTexto}</td>
      <td>${proveedorTexto}</td>
      <td>${producto.largo}x${producto.ancho}x${producto.alto}</td>
      <td>${producto.peso}kg</td>
      <td>$${producto.costo}</td>
      <td>${producto.sku_proveedor}</td>
      <td>${producto.sku_fabricante}</td>
      <td><button type="button" class="btn btn-sm btn-danger eliminar-fila">✕</button></td>
    `;
    tabla.appendChild(fila);
    fila.querySelector('.eliminar-fila').addEventListener('click', () => fila.remove());

    const form = document.getElementById('solicitud-form');
    inputs.forEach(input => {
      const hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.name = `form-${index}-${input.name.split('-')[2]}`;
      hidden.value = input.value;
      form.appendChild(hidden);
    });

    index++;
    totalForms.value = index;
    inputs.forEach(input => { input.value = ''; });
  });
});
</script>
{% endblock %}
