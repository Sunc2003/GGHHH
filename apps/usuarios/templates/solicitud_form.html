{% extends "base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/solicitud_form.css' %}">
<style>
  .menu-botones {
    display: flex;
    justify-content: center;
    flex-wrap: wrap;
    gap: 1.5rem;
    margin-bottom: 2rem;
  }

  .btn-cuadrado {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    width: 180px;
    height: 140px;
    background-color: #f1f3f5;
    color: #212529;
    border: none;
    border-radius: 1rem;
    font-weight: 600;
    font-size: 0.95rem;
    text-align: center;
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    transition: all 0.2s ease-in-out;
    text-decoration: none;
  }

  .btn-cuadrado:hover {
    background-color: #e2e6ea;
    transform: scale(1.05);
  }

  .btn-cuadrado img {
    width: 80px;
    height: 80px;
    margin-bottom: 10px;
  }

  .error-msg {
    color: #d9534f;
    font-size: 0.85rem;
    margin-top: 0.25rem;
  }

  @media (max-width: 576px) {
    .btn-cuadrado {
      width: 120px;
      height: 110px;
      font-size: 0.75rem;
    }

    .btn-cuadrado img {
      width: 32px;
      height: 32px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
  <!-- Menú principal -->
  <div class="menu-botones" id="menu-botones">
    <button id="btn-mostrar-form" class="btn-cuadrado">
      <img src="{% static 'img/ggh.png' %}" alt="Nuevo">Solicitar Código
    </button>
    <button id="btn-mostrar-enviadas" class="btn-cuadrado">
      <img src="{% static 'img/ggh.png' %}" alt="Enviadas">Enviadas
    </button>
    <a href="{% url 'solicitudes_recibidas' %}" class="btn-cuadrado">
      <img src="{% static 'img/ggh.png' %}" alt="Recibidas">Recibidas
    </a>
  </div>

  {% if messages %}
    {% for message in messages %}
      <div class="alert {% if message.tags == 'success' %}alert-success{% else %}alert-danger{% endif %}">
        {{ message }}
      </div>
    {% endfor %}
  {% endif %}

  <!-- Formulario Solicitud -->
  <div id="formulario-container" style="display:none;">
    <div class="card shadow-sm mx-auto" style="max-width: 1200px;">
      <div class="card-body">
        <h2 class="mb-4"><i class="fas fa-barcode"></i> Nueva Solicitud de Código SAP</h2>
        <form method="post" enctype="multipart/form-data" id="solicitud-form">
          {% csrf_token %}

          <!-- Información General -->
          <fieldset class="border rounded p-3 mb-4">
            <legend class="w-auto px-2">Información General</legend>
            <div class="row g-3">
              <div class="col-md-4">{{ form.receptor.label_tag }}{{ form.receptor }}{% for error in form.receptor.errors %}<div class="error-msg">{{ error }}</div>{% endfor %}</div>
              <div class="col-md-4">{{ form.empresa.label_tag }}{{ form.empresa }}{% for error in form.empresa.errors %}<div class="error-msg">{{ error }}</div>{% endfor %}</div>
              <div class="col-md-4">{{ form.tipo_solicitud.label_tag }}{{ form.tipo_solicitud }}{% for error in form.tipo_solicitud.errors %}<div class="error-msg">{{ error }}</div>{% endfor %}</div>
              <div class="col-md-4">{{ form.cotizacion.label_tag }}{{ form.cotizacion }}{% for error in form.cotizacion.errors %}<div class="error-msg">{{ error }}</div>{% endfor %}</div>
              <div class="col-md-4" id="campo_archivo" style="display:none;">
                {{ form.archivos.label_tag }}{{ form.archivos }}
                <small class="text-muted">Puedes seleccionar varios archivos</small>
              </div>
              <div class="col-md-4" id="campo_imagen" style="display:none;">
                {{ form.imagenes.label_tag }}{{ form.imagenes }}
                <small class="text-muted">Puedes seleccionar varias imágenes</small>
              </div>
            </div>
          </fieldset>

          <!-- Productos agregados -->
          <fieldset class="border rounded p-3 mb-4">
            <legend class="w-auto px-2">Productos Agregados</legend>
            <div class="table-responsive">
              <table class="table table-striped" id="tabla-detalles">
                <thead>
                  <tr>
                    <th>#</th><th>Descripción</th><th>Marca</th><th>UDM</th><th>Origen</th>
                    <th>Proveedor</th><th>Dimensiones</th><th>Peso</th><th>Costo</th>
                    <th>SKU Prov.</th><th>SKU Fab.</th><th></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </fieldset>

          <!-- Agregar producto -->
          <fieldset class="border rounded p-3 mb-4">
            <legend class="w-auto px-2">Agregar Producto</legend>
            <div class="row g-3" id="formset-actual">
              {% for field in formset.empty_form.visible_fields %}
                <div class="col-md-3">
                  {{ field.label_tag }}{{ field }}
                  {% for error in field.errors %}<div class="error-msg">{{ error }}</div>{% endfor %}
                </div>
              {% endfor %}
            </div>
            {{ formset.management_form }}
            <button type="button" class="btn btn-outline-primary mt-2" id="add-product-btn">+ Agregar Producto</button>
          </fieldset>

          <!-- Mensaje -->
          <fieldset class="border rounded p-3 mb-4">
            <legend class="w-auto px-2">Mensaje</legend>
            <div class="mb-3">
              {{ form.mensaje.label_tag }}{{ form.mensaje }}
              {% for error in form.mensaje.errors %}<div class="error-msg">{{ error }}</div>{% endfor %}
            </div>
          </fieldset>

          <button type="submit" class="btn btn-success px-4 py-2">
            <i class="fas fa-paper-plane"></i> Enviar Solicitud
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Solicitudes enviadas -->
  <div id="solicitudes-enviadas" style="display:none;">
    <div class="card shadow-sm mx-auto" style="max-width: 1200px;">
      <div class="card-body">
        <h3>Solicitudes Enviadas</h3>
        <table class="table table-hover">
          <thead><tr><th>#</th><th>Empresa</th><th>Tipo</th><th>Estado</th><th>Fecha</th><th></th></tr></thead>
          <tbody>
            {% for s in solicitudes_enviadas %}
              <tr>
                <td>{{ forloop.counter }}</td>
                <td>{{ s.get_empresa_display }}</td>
                <td>{{ s.get_tipo_solicitud_display }}</td>
                <td>{{ s.get_estado_display }}</td>
                <td>{{ s.fecha_creacion|date:"d-m-Y H:i" }}</td>
                <td><a href="{% url 'detalle_solicitud' s.id %}" class="btn btn-sm btn-outline-primary">Ver</a></td>
              </tr>
            {% empty %}
              <tr><td colspan="6" class="text-center">No has enviado solicitudes aún.</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- JS -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const menu = document.getElementById('menu-botones');
  const formContainer = document.getElementById('formulario-container');
  const solicitudesContainer = document.getElementById('solicitudes-enviadas');
  const cotSelect = document.getElementById('id_cotizacion');
  const campoArchivo = document.getElementById('campo_archivo');
  const campoImagen = document.getElementById('campo_imagen');
  const tabla = document.querySelector('#tabla-detalles tbody');
  const addBtn = document.getElementById('add-product-btn');
  const totalForms = document.getElementById('id_form-TOTAL_FORMS');
  let index = parseInt(totalForms.value);

  document.getElementById('btn-mostrar-form').onclick = () => {
    formContainer.style.display = 'block';
    solicitudesContainer.style.display = 'none';
    menu.style.display = 'none';
  };

  document.getElementById('btn-mostrar-enviadas').onclick = () => {
    formContainer.style.display = 'none';
    solicitudesContainer.style.display = 'block';
    menu.style.display = 'none';
  };

  if (cotSelect) {
    cotSelect.addEventListener('change', () => {
      campoArchivo.style.display = cotSelect.value === 'documento' ? 'block' : 'none';
      campoImagen.style.display = cotSelect.value === 'whatsapp' ? 'block' : 'none';
    });
    cotSelect.dispatchEvent(new Event('change'));
  }

  addBtn.addEventListener('click', () => {
    const currentForm = document.querySelector('#formset-actual');
    const inputs = currentForm.querySelectorAll('input, select, textarea');
    const producto = {};
    let valido = true;

    inputs.forEach(input => {
      if (!input.value && input.required !== false) {
        input.classList.add('is-invalid');
        valido = false;
      } else {
        input.classList.remove('is-invalid');
        producto[input.name.split('-')[2]] = input.value;
      }
    });

    if (!valido) return;

    const fila = document.createElement('tr');
    fila.innerHTML = `
      <td>${index+1}</td>
      <td>${producto.descripcion}</td>
      <td>${currentForm.querySelector('select[name$="-marca"]').selectedOptions[0]?.text || ''}</td>
      <td>${currentForm.querySelector('select[name$="-udm"]').selectedOptions[0]?.text || ''}</td>
      <td>${currentForm.querySelector('select[name$="-origen"]').selectedOptions[0]?.text || ''}</td>
      <td>${currentForm.querySelector('select[name$="-proveedor"]').selectedOptions[0]?.text || ''}</td>
      <td>${producto.largo}x${producto.ancho}x${producto.alto}</td>
      <td>${producto.peso}kg</td>
      <td>$${producto.costo}</td>
      <td>${producto.sku_proveedor}</td>
      <td>${producto.sku_fabricante}</td>
      <td><button type="button" class="btn btn-sm btn-danger eliminar-fila">✕</button></td>
    `;
    tabla.appendChild(fila);
    fila.querySelector('.eliminar-fila').addEventListener('click', () => fila.remove());

    const form = document.getElementById('solicitud-form');
    inputs.forEach(input => {
      const hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.name = `form-${index}-${input.name.split('-')[2]}`;
      hidden.value = input.value;
      form.appendChild(hidden);
    });

    index++;
    totalForms.value = index;
    inputs.forEach(input => { input.value = ''; });
  });
});
</script>
{% endblock %}


