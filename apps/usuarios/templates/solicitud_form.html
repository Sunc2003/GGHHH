{% extends "base.html" %}
{% load permisos_tags %}
{% load static %}
 
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/solicitud_form.css' %}">
<style>
  .menu-botones{display:flex;justify-content:center;flex-wrap:wrap;gap:1.5rem;margin-bottom:2rem;}
  .btn-cuadrado{display:flex;flex-direction:column;align-items:center;justify-content:center;width:180px;height:140px;background:#f1f3f5;color:#212529;border:none;border-radius:1rem;font-weight:600;font-size:.95rem;text-align:center;box-shadow:0 4px 8px rgba(0,0,0,.1);transition:all .2s;text-decoration:none;cursor:pointer;}
  .btn-cuadrado:hover{background:#e2e6ea;transform:scale(1.05);}
  .btn-cuadrado img{width:80px;height:80px;margin-bottom:10px;}
  .error-msg{color:#d9534f;font-size:.85rem;margin-top:.25rem;}
  @media (max-width:576px){
    .btn-cuadrado{width:120px;height:110px;font-size:.75rem;}
    .btn-cuadrado img{width:32px;height:32px;}
  }
  .is-invalid{border-color:#dc3545 !important;}
</style>
{% endblock %}

{% block content %}
<div class="container py-5">
  <!-- Menú principal -->
  <div class="menu-botones" id="menu-botones">
    {% if request.user.is_authenticated and request.user|tiene_permiso:"ENVIAR_SOLICITUD" %}
    <button id="btn-mostrar-form" class="btn-cuadrado">
      <img src="{% static 'img/ggh.png' %}" alt="Nuevo">Solicitar Código
    </button>
    {% endif %}
    {% if request.user.is_authenticated and request.user|tiene_permiso:"VER_SOLICITUDES" %}
    <a href="{% url 'solicitudes_enviadas' %}" class="btn-cuadrado">
      <img src="{% static 'img/ggh.png' %}" alt="Enviadas">Enviadas
    </a>
    {% endif %}
    {% if request.user.is_authenticated and request.user|tiene_permiso:"VER_SOLICITUDES_RECIBIDAS" %}
    <a href="{% url 'solicitudes_recibidas' %}" class="btn-cuadrado">
      <img src="{% static 'img/ggh.png' %}" alt="Recibidas">Recibidas
    </a>
    {% endif %}
  </div>

  <!-- Submenú oculto -->
  <div id="submenu-opciones" class="menu-botones" style="display:none; margin-top:2rem;">
    <button class="btn-cuadrado opcion-solicitud" data-tipo="nuevo_articulo">Nuevo artículo</button>
    <button class="btn-cuadrado opcion-solicitud" data-tipo="produccion">Producción</button>
    <button class="btn-cuadrado opcion-solicitud" data-tipo="activacion">Activación</button>
    <button class="btn-cuadrado opcion-solicitud" data-tipo="modificacion">Modificación</button>
  </div>
 
  <!-- Formulario COMPLETO (Nuevo Artículo / Producción) -->
  <div id="formulario-container" style="display:none;">
    <div class="card shadow-sm mx-auto" style="max-width: 1200px;">
      <div class="card-body">
        <h2 class="mb-4"><i class="fas fa-barcode"></i> Nueva Solicitud de Código SAP</h2>
        <form method="post" enctype="multipart/form-data" id="solicitud-form">
          {% csrf_token %}
          <input type="hidden" name="tipo_opcion" id="tipo-opcion">

          <!-- Información General -->
          <fieldset class="border rounded p-3 mb-4">
            <legend class="w-auto px-2">Información General</legend>
            <div class="row g-3">
              <div class="col-md-4">{{ form.receptor.label_tag }}{{ form.receptor }}</div>
              <div class="col-md-4">{{ form.empresa.label_tag }}{{ form.empresa }}</div>
              <div class="col-md-4">{{ form.tipo_solicitud.label_tag }}{{ form.tipo_solicitud }}</div>
              <div class="col-md-4">{{ form.cotizacion.label_tag }}{{ form.cotizacion }}</div>
              <div class="col-md-4" id="campo_archivo" style="display:none;">
                {{ form.archivos.label_tag }}{{ form.archivos }}
                <small class="text-muted">Puedes seleccionar varios archivos</small>
              </div>
              <div class="col-md-4" id="campo_imagen" style="display:none;">
                {{ form.imagenes.label_tag }}{{ form.imagenes }}
                <small class="text-muted">Puedes seleccionar varias imágenes</small>
              </div>
            </div>
          </fieldset>
 
          <!-- Agregar producto -->
          <fieldset class="border rounded p-3 mb-4">
            <legend class="w-auto px-2">Agregar Producto</legend>
            <div class="row g-3" id="formset-actual">
              {% for field in formset.empty_form.visible_fields %}
                <div class="col-md-3">{{ field.label_tag }}{{ field }}</div>
              {% endfor %}
            </div>
            {{ formset.management_form }}
            <button type="button" class="btn btn-outline-primary mt-2" id="add-product-btn">+ Agregar Producto</button>
          </fieldset>
 
          <!-- Productos agregados -->
          <fieldset class="border rounded p-3 mb-4">
            <legend class="w-auto px-2">Productos Agregados</legend>
            <div class="table-responsive">
              <table class="table table-striped" id="tabla-detalles">
                <thead>
                  <tr>
                    <th>#</th><th>Descripción</th><th>Marca</th><th>UDM</th><th>Origen</th>
                    <th>Proveedor</th><th>Dimensiones</th><th>Peso</th><th>Costo</th>
                    <th>SKU Prov.</th><th>SKU Fab.</th><th></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </fieldset>
 
          <!-- Mensaje -->
          <fieldset class="border rounded p-3 mb-4">
            <legend class="w-auto px-2">Mensaje</legend>
            <div class="mb-3">{{ form.mensaje.label_tag }}{{ form.mensaje }}</div>
          </fieldset>
 
          <button type="submit" class="btn btn-success px-4 py-2">
            <i class="fas fa-paper-plane"></i> Enviar Solicitud
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Formulario Activación / Modificación (mejorado y responsive) -->
  <div id="form-activacion" style="display:none;">
    <div class="card shadow-sm mx-auto" style="max-width:600px;">
      <div class="card-header bg-dark text-white d-flex align-items-center">
        <i class="fas fa-edit me-2"></i>
        <h5 class="mb-0" id="titulo-activacion">Solicitud</h5>
      </div>
      <div class="card-body">
        <form method="post" id="form-activacion-real">
          {% csrf_token %}
          <input type="hidden" name="tipo_opcion" id="tipo-opcion-activacion">

          <!-- Información General -->
          <div class="mb-4">
            <h6 class="border-bottom pb-2">Información General</h6>
            <div class="row g-3">
              <div class="col-md-6 col-12">{{ form.receptor.label_tag }}{{ form.receptor }}</div>
              <div class="col-md-6 col-12">{{ form.empresa.label_tag }}{{ form.empresa }}</div>
            </div>
          </div>

          <!-- Código -->
          <div class="mb-4">
            <div class="mb-3">
              <label for="codigo_extra" class="form-label">Código</label>
              <input type="text" name="codigo_extra" id="codigo_extra" class="form-control"
                     placeholder="Ingrese el código SAP" required>
              <small class="text-muted"></small>
            </div>
          </div>

          <!-- Detalle -->
          <div class="mb-4">
            <label for="codigo_extra" class="form-label">Detalle</label>
            <textarea name="mensaje" id="mensaje_activacion" class="form-control" rows="3"
                      placeholder="Agregue un detalle " required></textarea>
          </div>

          <!-- Botones -->
          <div class="text-end">
            <button type="submit" class="btn btn-success btn-sm">
              <i class="fas fa-paper-plane me-1"></i> Enviar
            </button>
            <button type="button" class="btn btn-outline-secondary btn-sm ms-2" onclick="history.back();">
              <i class="fas fa-times me-1"></i> Cancelar
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const menu = document.getElementById('menu-botones');
  const submenu = document.getElementById('submenu-opciones');
  const formCompleto = document.getElementById('formulario-container');
  const formActivacion = document.getElementById('form-activacion');
  const tituloActivacion = document.getElementById('titulo-activacion');
  const tipoInputActivacion = document.getElementById('tipo-opcion-activacion');
  const btnMostrarForm = document.getElementById('btn-mostrar-form');
  const tipoInput = document.getElementById('tipo-opcion');

  if (btnMostrarForm) {
    btnMostrarForm.onclick = () => { menu.style.display = 'none'; submenu.style.display = 'flex'; };
  }

  document.querySelectorAll('.opcion-solicitud').forEach(btn => {
    btn.addEventListener('click', () => {
      const tipo = btn.dataset.tipo;
      submenu.style.display = 'none';

      if (tipo === 'activacion' || tipo === 'modificacion') {
        formActivacion.style.display = 'block';
        tipoInputActivacion.value = tipo;
        tituloActivacion.innerHTML = tipo === 'activacion'
          ? '<i class="fas fa-bolt me-1"></i> Solicitud de Activación'
          : '<i class="fas fa-edit me-1"></i> Solicitud de Modificación';
      } else {
        tipoInput.value = tipo;
        formCompleto.style.display = 'block';
      }
    });
  });
});
</script>
{% endblock %}
