{% extends "base.html" %}
{% load permisos_tags %}
{% load static %}
 
{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/solicitud_form.css' %}">
<style>
  .menu-botones{display:flex;justify-content:center;flex-wrap:wrap;gap:1.5rem;margin-bottom:2rem;}
  .btn-cuadrado{display:flex;flex-direction:column;align-items:center;justify-content:center;width:180px;height:140px;background:#f1f3f5;color:#212529;border:none;border-radius:1rem;font-weight:600;font-size:.95rem;text-align:center;box-shadow:0 4px 8px rgba(0,0,0,.1);transition:all .2s;text-decoration:none;}
  .btn-cuadrado:hover{background:#e2e6ea;transform:scale(1.05);}
  .btn-cuadrado img{width:80px;height:80px;margin-bottom:10px;}
  .error-msg{color:#d9534f;font-size:.85rem;margin-top:.25rem;}
  @media (max-width:576px){
    .btn-cuadrado{width:120px;height:110px;font-size:.75rem;}
    .btn-cuadrado img{width:32px;height:32px;}
  }
  .is-invalid{border-color:#dc3545 !important;}
</style>
{% endblock %}
 
{% block content %}
<div class="container py-5">
  <!-- Menú principal -->
  <div class="menu-botones" id="menu-botones">
    {% if request.user.is_authenticated and request.user|tiene_permiso:"ENVIAR_SOLICITUD" %}
    <button id="btn-mostrar-form" class="btn-cuadrado">
      <img src="{% static 'img/ggh.png' %}" alt="Nuevo">Solicitar Código
    </button>
    {% endif %}
    {% if request.user.is_authenticated and request.user|tiene_permiso:"VER_SOLICITUDES" %}
    <a href="{% url 'solicitudes_enviadas' %}" class="btn-cuadrado">
      <img src="{% static 'img/ggh.png' %}" alt="Enviadas">Enviadas
    </a>
    {% endif %}
    {% if request.user.is_authenticated and request.user|tiene_permiso:"VER_SOLICITUDES_RECIBIDAS" %}
    <a href="{% url 'solicitudes_recibidas' %}" class="btn-cuadrado">
      <img src="{% static 'img/ggh.png' %}" alt="Recibidas">Recibidas
    </a>
    {% endif %}
  </div>
 
  <!-- Formulario Solicitud -->
  <div id="formulario-container" style="display:none;">
    <div class="card shadow-sm mx-auto" style="max-width: 1200px;">
      <div class="card-body">
        <h2 class="mb-4"><i class="fas fa-barcode"></i> Nueva Solicitud de Código SAP</h2>
        <form method="post" enctype="multipart/form-data" id="solicitud-form">
          {% csrf_token %}
 
          <!-- Información General -->
          <fieldset class="border rounded p-3 mb-4">
            <legend class="w-auto px-2">Información General</legend>
            <div class="row g-3">
              <div class="col-md-4">{{ form.receptor.label_tag }}{{ form.receptor }}{% for error in form.receptor.errors %}<div class="error-msg">{{ error }}</div>{% endfor %}</div>
              <div class="col-md-4">{{ form.empresa.label_tag }}{{ form.empresa }}{% for error in form.empresa.errors %}<div class="error-msg">{{ error }}</div>{% endfor %}</div>
              <div class="col-md-4">{{ form.tipo_solicitud.label_tag }}{{ form.tipo_solicitud }}{% for error in form.tipo_solicitud.errors %}<div class="error-msg">{{ error }}</div>{% endfor %}</div>
              <div class="col-md-4">{{ form.cotizacion.label_tag }}{{ form.cotizacion }}{% for error in form.cotizacion.errors %}<div class="error-msg">{{ error }}</div>{% endfor %}</div>
              <div class="col-md-4" id="campo_archivo" style="display:none;">
                {{ form.archivos.label_tag }}{{ form.archivos }}
                <small class="text-muted">Puedes seleccionar varios archivos</small>
              </div>
              <div class="col-md-4" id="campo_imagen" style="display:none;">
                {{ form.imagenes.label_tag }}{{ form.imagenes }}
                <small class="text-muted">Puedes seleccionar varias imágenes</small>
              </div>
            </div>
          </fieldset>
 
          <!-- Agregar producto -->
          <fieldset class="border rounded p-3 mb-4">
            <legend class="w-auto px-2">Agregar Producto</legend>
            <div class="row g-3" id="formset-actual">
              {% for field in formset.empty_form.visible_fields %}
                <div class="col-md-3">
                  {{ field.label_tag }}{{ field }}
                  {% for error in field.errors %}<div class="error-msg">{{ error }}</div>{% endfor %}
                </div>
              {% endfor %}
            </div>
            {{ formset.management_form }}
            <button type="button" class="btn btn-outline-primary mt-2" id="add-product-btn">+ Agregar Producto</button>
          </fieldset>
 
          <!-- Productos agregados -->
          <fieldset class="border rounded p-3 mb-4">
            <legend class="w-auto px-2">Productos Agregados</legend>
            <div class="table-responsive">
              <table class="table table-striped" id="tabla-detalles">
                <thead>
                  <tr>
                    <th>#</th><th>Descripción</th><th>Marca</th><th>UDM</th><th>Origen</th>
                    <th>Proveedor</th><th>Dimensiones</th><th>Peso</th><th>Costo</th>
                    <th>SKU Prov.</th><th>SKU Fab.</th><th></th>
                  </tr>
                </thead>
                <tbody></tbody>
              </table>
            </div>
          </fieldset>
 
          <!-- Mensaje -->
          <fieldset class="border rounded p-3 mb-4">
            <legend class="w-auto px-2">Mensaje</legend>
            <div class="mb-3">
              {{ form.mensaje.label_tag }}{{ form.mensaje }}
              {% for error in form.mensaje.errors %}<div class="error-msg">{{ error }}</div>{% endfor %}
            </div>
          </fieldset>
 
          <button type="submit" class="btn btn-success px-4 py-2">
            <i class="fas fa-paper-plane"></i> Enviar Solicitud
          </button>
        </form>
      </div>
    </div>
  </div>
</div>
 
<script>
document.addEventListener('DOMContentLoaded', () => {
  const menu = document.getElementById('menu-botones');
  const formContainer = document.getElementById('formulario-container');
  const formEl = document.getElementById('solicitud-form');
 
  const cotSelect = document.getElementById('id_cotizacion');
  const campoArchivo = document.getElementById('campo_archivo');
  const campoImagen = document.getElementById('campo_imagen');
  const inputArchivos = campoArchivo ? campoArchivo.querySelector('input[type="file"]') : null;
  const inputImagenes = campoImagen ? campoImagen.querySelector('input[type="file"]') : null;
 
  const tabla = document.querySelector('#tabla-detalles tbody');
  const addBtn = document.getElementById('add-product-btn');
  const totalForms = document.getElementById('id_form-TOTAL_FORMS');
  let index = parseInt(totalForms.value);
 
  const REQUIRED_KEYS = [
    'descripcion','marca','udm','origen','proveedor',
    'largo','ancho','alto','peso','costo',
    'sku_proveedor','sku_fabricante'
  ];
 
  const btnMostrar = document.getElementById('btn-mostrar-form');
  if (btnMostrar) {
    btnMostrar.onclick = () => { formContainer.style.display = 'block'; menu.style.display = 'none'; };
  }
 
  const isVisible = (el) => !!(el.offsetParent || el.getClientRects().length);
  const trimVal = (v) => (typeof v === 'string' ? v.trim() : v);
 
  if (cotSelect) {
    const toggleArchivosImagenes = () => {
      const v = cotSelect.value;
      const doc = v === 'documento';
      const img = v === 'whatsapp';
      if (campoArchivo) campoArchivo.style.display = doc ? 'block' : 'none';
      if (inputArchivos) inputArchivos.required = doc;
      if (campoImagen)  campoImagen.style.display  = img ? 'block' : 'none';
      if (inputImagenes) inputImagenes.required = img;
    };
    cotSelect.addEventListener('change', toggleArchivosImagenes);
    toggleArchivosImagenes();
  }
 
  const showError = (el, msg='Campo obligatorio') => {
    el.classList.add('is-invalid');
    let help = el.parentElement.querySelector('.error-msg');
    if (!help) {
      help = document.createElement('div');
      help.className = 'error-msg';
      el.parentElement.appendChild(help);
    }
    help.textContent = msg;
  };
  const clearError = (el) => {
    el.classList.remove('is-invalid');
    const help = el.parentElement.querySelector('.error-msg');
    if (help) help.remove();
  };
 
  formEl.addEventListener('submit', (e) => {
    const requiredEls = formEl.querySelectorAll('[required]');
    let firstInvalid = null, valid = true;
    requiredEls.forEach(el => {
      if (!isVisible(el)) return;
      const val = trimVal(el.value);
      const ok = val !== '' && !(el.type === 'select-one' && (val === '' || val === null));
      if (!ok) { showError(el); if (!firstInvalid) firstInvalid = el; valid = false; }
      else { clearError(el); }
    });
    if (!valid) { e.preventDefault(); if (firstInvalid) firstInvalid.focus(); }
  });
 
  // 💡 Hacer que el campo peso acepte decimales
  const pesoInput = document.querySelector('[name$="-peso"]');
  if (pesoInput) {
    pesoInput.type = 'number';
    pesoInput.step = '0.01';
  }
 
  addBtn.addEventListener('click', () => {
    const currentForm = document.querySelector('#formset-actual');
 
    let valido = true, firstInvalid = null;
    const values = {};
 
    for (const key of REQUIRED_KEYS) {
      const el = currentForm.querySelector(`[name$="-${key}"]`);
      if (!el) continue;
      const raw = trimVal(el.value);
      const empty = (el.tagName === 'SELECT') ? (raw === '' || el.selectedIndex === 0) : (raw === '');
      if (empty) {
        showError(el);
        if (!firstInvalid) firstInvalid = el;
        valido = false;
      } else {
        clearError(el);
        const type = (el.type || '').toLowerCase();
        if (['text','textarea','search','tel','url','email'].includes(type)) {
          el.value = raw.toUpperCase();
          values[key] = el.value;
        } else {
          values[key] = raw;
        }
      }
      el.addEventListener('input', () => clearError(el), { once: true });
      el.addEventListener('change', () => clearError(el), { once: true });
    }
 
    if (!valido) { if (firstInvalid) firstInvalid.focus(); return; }
 
    const txt = (nameEnd) =>
      currentForm.querySelector(`select[name$="-${nameEnd}"]`)?.selectedOptions[0]?.text?.toUpperCase() || '';
 
    const txtMarca  = txt('marca');
    const txtUdm    = txt('udm');
    const txtOrigen = txt('origen');
    const txtProv   = txt('proveedor');
 
    const fila = document.createElement('tr');
    fila.innerHTML = `
      <td>${index + 1}</td>
      <td>${values.descripcion || ''}</td>
      <td>${txtMarca}</td>
      <td>${txtUdm}</td>
      <td>${txtOrigen}</td>
      <td>${txtProv}</td>
      <td>${(values.largo||'')}x${(values.ancho||'')}x${(values.alto||'')}</td>
      <td>${values.peso ? (parseFloat(values.peso).toFixed(2) + 'kg') : ''}</td>
      <td>${values.costo ? ('$' + values.costo) : ''}</td>
      <td>${values.sku_proveedor || ''}</td>
      <td>${values.sku_fabricante || ''}</td>
      <td><button type="button" class="btn btn-sm btn-danger eliminar-fila">✕</button></td>
    `;
    tabla.appendChild(fila);
    fila.querySelector('.eliminar-fila').addEventListener('click', () => fila.remove());
 
    for (const key of Object.keys(values)) {
      const hidden = document.createElement('input');
      hidden.type = 'hidden';
      hidden.name = `form-${index}-${key}`;
      hidden.value = values[key];
      formEl.appendChild(hidden);
    }
 
    index++;
    totalForms.value = index;
 
    currentForm.querySelectorAll('input, select, textarea').forEach(el => {
      if (el.tagName === 'SELECT') el.selectedIndex = 0;
      else el.value = '';
      clearError(el);
    });
 
    document.querySelector('#tabla-detalles').scrollIntoView({ behavior: 'smooth' });
  });
});
</script>
 
{% endblock %}